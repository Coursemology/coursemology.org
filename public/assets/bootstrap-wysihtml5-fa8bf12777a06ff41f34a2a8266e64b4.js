/**
 * @license wysihtml5 v0.3.0
 * https://github.com/xing/wysihtml5
 *
 * Author: Christopher Blum (https://github.com/tiff)
 *
 * Copyright (C) 2012 XING AG
 * Licensed under the MIT license (MIT)
 *
 */
var wysihtml5={version:"0.3.0",commands:{},dom:{},quirks:{},toolbar:{},lang:{},selection:{},views:{},INVISIBLE_SPACE:"ï»¿",EMPTY_FUNCTION:function(){},ELEMENT_NODE:1,TEXT_NODE:3,BACKSPACE_KEY:8,ENTER_KEY:13,ESCAPE_KEY:27,SPACE_KEY:32,DELETE_KEY:46};/**
 * @license Rangy, a cross-browser JavaScript range and selection library
 * http://code.google.com/p/rangy/
 *
 * Copyright 2011, Tim Down
 * Licensed under the MIT license.
 * Version: 1.2.2
 * Build date: 13 November 2011
 */
window.rangy=function(){function isHostMethod(o,p){var t=typeof o[p];return t==FUNCTION||!(t!=OBJECT||!o[p])||"unknown"==t}function isHostObject(o,p){return!(typeof o[p]!=OBJECT||!o[p])}function isHostProperty(o,p){return typeof o[p]!=UNDEFINED}function createMultiplePropertyTest(testFunc){return function(o,props){for(var i=props.length;i--;)if(!testFunc(o,props[i]))return!1;return!0}}function isTextRange(range){return range&&areHostMethods(range,textRangeMethods)&&areHostProperties(range,textRangeProperties)}function fail(reason){window.alert("Rangy not supported in your browser. Reason: "+reason),api.initialized=!0,api.supported=!1}function warn(msg){var warningMessage="Rangy warning: "+msg;api.config.alertOnWarn?window.alert(warningMessage):typeof window.console!=UNDEFINED&&typeof window.console.log!=UNDEFINED&&window.console.log(warningMessage)}function init(){if(!api.initialized){var testRange,implementsDomRange=!1,implementsTextRange=!1;isHostMethod(document,"createRange")&&(testRange=document.createRange(),areHostMethods(testRange,domRangeMethods)&&areHostProperties(testRange,domRangeProperties)&&(implementsDomRange=!0),testRange.detach());var body=isHostObject(document,"body")?document.body:document.getElementsByTagName("body")[0];body&&isHostMethod(body,"createTextRange")&&(testRange=body.createTextRange(),isTextRange(testRange)&&(implementsTextRange=!0)),implementsDomRange||implementsTextRange||fail("Neither Range nor TextRange are implemented"),api.initialized=!0,api.features={implementsDomRange:implementsDomRange,implementsTextRange:implementsTextRange};for(var allListeners=moduleInitializers.concat(initListeners),i=0,len=allListeners.length;len>i;++i)try{allListeners[i](api)}catch(ex){isHostObject(window,"console")&&isHostMethod(window.console,"log")&&window.console.log("Init listener threw an exception. Continuing.",ex)}}}function createMissingNativeApi(win){win=win||window,init();for(var i=0,len=createMissingNativeApiListeners.length;len>i;++i)createMissingNativeApiListeners[i](win)}function Module(name){this.name=name,this.initialized=!1,this.supported=!1}var OBJECT="object",FUNCTION="function",UNDEFINED="undefined",domRangeProperties=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer","START_TO_START","START_TO_END","END_TO_START","END_TO_END"],domRangeMethods=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],textRangeProperties=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],textRangeMethods=["collapse","compareEndPoints","duplicate","getBookmark","moveToBookmark","moveToElementText","parentElement","pasteHTML","select","setEndPoint","getBoundingClientRect"],areHostMethods=createMultiplePropertyTest(isHostMethod),areHostObjects=createMultiplePropertyTest(isHostObject),areHostProperties=createMultiplePropertyTest(isHostProperty),api={version:"1.2.2",initialized:!1,supported:!0,util:{isHostMethod:isHostMethod,isHostObject:isHostObject,isHostProperty:isHostProperty,areHostMethods:areHostMethods,areHostObjects:areHostObjects,areHostProperties:areHostProperties,isTextRange:isTextRange},features:{},modules:{},config:{alertOnWarn:!1,preferTextRange:!1}};api.fail=fail,api.warn=warn,{}.hasOwnProperty?api.util.extend=function(o,props){for(var i in props)props.hasOwnProperty(i)&&(o[i]=props[i])}:fail("hasOwnProperty not supported");var initListeners=[],moduleInitializers=[];api.init=init,api.addInitListener=function(listener){api.initialized?listener(api):initListeners.push(listener)};var createMissingNativeApiListeners=[];api.addCreateMissingNativeApiListener=function(listener){createMissingNativeApiListeners.push(listener)},api.createMissingNativeApi=createMissingNativeApi,Module.prototype.fail=function(reason){throw this.initialized=!0,this.supported=!1,new Error("Module '"+this.name+"' failed to load: "+reason)},Module.prototype.warn=function(msg){api.warn("Module "+this.name+": "+msg)},Module.prototype.createError=function(msg){return new Error("Error in Rangy "+this.name+" module: "+msg)},api.createModule=function(name,initFunc){var module=new Module(name);api.modules[name]=module,moduleInitializers.push(function(api){initFunc(api,module),module.initialized=!0,module.supported=!0})},api.requireModules=function(modules){for(var module,moduleName,i=0,len=modules.length;len>i;++i){if(moduleName=modules[i],module=api.modules[moduleName],!(module&&module instanceof Module))throw new Error("Module '"+moduleName+"' not found");if(!module.supported)throw new Error("Module '"+moduleName+"' not supported")}};var docReady=!1,loadHandler=function(){docReady||(docReady=!0,api.initialized||init())};return typeof window==UNDEFINED?(fail("No window found"),void 0):typeof document==UNDEFINED?(fail("No document found"),void 0):(isHostMethod(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",loadHandler,!1),isHostMethod(window,"addEventListener")?window.addEventListener("load",loadHandler,!1):isHostMethod(window,"attachEvent")?window.attachEvent("onload",loadHandler):fail("Window does not have required addEventListener or attachEvent method"),api)}(),rangy.createModule("DomUtil",function(api,module){function isHtmlNamespace(node){var ns;return typeof node.namespaceURI==UNDEF||null===(ns=node.namespaceURI)||"http://www.w3.org/1999/xhtml"==ns}function parentElement(node){var parent=node.parentNode;return 1==parent.nodeType?parent:null}function getNodeIndex(node){for(var i=0;node=node.previousSibling;)i++;return i}function getNodeLength(node){var childNodes;return isCharacterDataNode(node)?node.length:(childNodes=node.childNodes)?childNodes.length:0}function getCommonAncestor(node1,node2){var n,ancestors=[];for(n=node1;n;n=n.parentNode)ancestors.push(n);for(n=node2;n;n=n.parentNode)if(arrayContains(ancestors,n))return n;return null}function isAncestorOf(ancestor,descendant,selfIsAncestor){for(var n=selfIsAncestor?descendant:descendant.parentNode;n;){if(n===ancestor)return!0;n=n.parentNode}return!1}function getClosestAncestorIn(node,ancestor,selfIsAncestor){for(var p,n=selfIsAncestor?node:node.parentNode;n;){if(p=n.parentNode,p===ancestor)return n;n=p}return null}function isCharacterDataNode(node){var t=node.nodeType;return 3==t||4==t||8==t}function insertAfter(node,precedingNode){var nextNode=precedingNode.nextSibling,parent=precedingNode.parentNode;return nextNode?parent.insertBefore(node,nextNode):parent.appendChild(node),node}function splitDataNode(node,index){var newNode=node.cloneNode(!1);return newNode.deleteData(0,index),node.deleteData(index,node.length-index),insertAfter(newNode,node),newNode}function getDocument(node){if(9==node.nodeType)return node;if(typeof node.ownerDocument!=UNDEF)return node.ownerDocument;if(typeof node.document!=UNDEF)return node.document;if(node.parentNode)return getDocument(node.parentNode);throw new Error("getDocument: no document found for node")}function getWindow(node){var doc=getDocument(node);if(typeof doc.defaultView!=UNDEF)return doc.defaultView;if(typeof doc.parentWindow!=UNDEF)return doc.parentWindow;throw new Error("Cannot get a window object for node")}function getIframeDocument(iframeEl){if(typeof iframeEl.contentDocument!=UNDEF)return iframeEl.contentDocument;if(typeof iframeEl.contentWindow!=UNDEF)return iframeEl.contentWindow.document;throw new Error("getIframeWindow: No Document object found for iframe element")}function getIframeWindow(iframeEl){if(typeof iframeEl.contentWindow!=UNDEF)return iframeEl.contentWindow;if(typeof iframeEl.contentDocument!=UNDEF)return iframeEl.contentDocument.defaultView;throw new Error("getIframeWindow: No Window object found for iframe element")}function getBody(doc){return util.isHostObject(doc,"body")?doc.body:doc.getElementsByTagName("body")[0]}function getRootContainer(node){for(var parent;parent=node.parentNode;)node=parent;return node}function comparePoints(nodeA,offsetA,nodeB,offsetB){var nodeC,root,childA,childB,n;if(nodeA==nodeB)return offsetA===offsetB?0:offsetB>offsetA?-1:1;if(nodeC=getClosestAncestorIn(nodeB,nodeA,!0))return offsetA<=getNodeIndex(nodeC)?-1:1;if(nodeC=getClosestAncestorIn(nodeA,nodeB,!0))return getNodeIndex(nodeC)<offsetB?-1:1;if(root=getCommonAncestor(nodeA,nodeB),childA=nodeA===root?root:getClosestAncestorIn(nodeA,root,!0),childB=nodeB===root?root:getClosestAncestorIn(nodeB,root,!0),childA===childB)throw new Error("comparePoints got to case 4 and childA and childB are the same!");for(n=root.firstChild;n;){if(n===childA)return-1;if(n===childB)return 1;n=n.nextSibling}throw new Error("Should not be here!")}function fragmentFromNodeChildren(node){for(var child,fragment=getDocument(node).createDocumentFragment();child=node.firstChild;)fragment.appendChild(child);return fragment}function inspectNode(node){if(!node)return"[No node]";if(isCharacterDataNode(node))return'"'+node.data+'"';if(1==node.nodeType){var idAttr=node.id?' id="'+node.id+'"':"";return"<"+node.nodeName+idAttr+">["+node.childNodes.length+"]"}return node.nodeName}function NodeIterator(root){this.root=root,this._next=root}function createIterator(root){return new NodeIterator(root)}function DomPosition(node,offset){this.node=node,this.offset=offset}function DOMException(codeName){this.code=this[codeName],this.codeName=codeName,this.message="DOMException: "+this.codeName}var UNDEF="undefined",util=api.util;util.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||module.fail("document missing a Node creation method"),util.isHostMethod(document,"getElementsByTagName")||module.fail("document missing getElementsByTagName method");var el=document.createElement("div");util.areHostMethods(el,["insertBefore","appendChild","cloneNode"]||!util.areHostObjects(el,["previousSibling","nextSibling","childNodes","parentNode"]))||module.fail("Incomplete Element implementation"),util.isHostProperty(el,"innerHTML")||module.fail("Element is missing innerHTML property");var textNode=document.createTextNode("test");util.areHostMethods(textNode,["splitText","deleteData","insertData","appendData","cloneNode"]||!util.areHostObjects(el,["previousSibling","nextSibling","childNodes","parentNode"])||!util.areHostProperties(textNode,["data"]))||module.fail("Incomplete Text Node implementation");var arrayContains=function(arr,val){for(var i=arr.length;i--;)if(arr[i]===val)return!0;return!1};NodeIterator.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var child,next,n=this._current=this._next;if(this._current)if(child=n.firstChild)this._next=child;else{for(next=null;n!==this.root&&!(next=n.nextSibling);)n=n.parentNode;this._next=next}return this._current},detach:function(){this._current=this._next=this.root=null}},DomPosition.prototype={equals:function(pos){return this.node===pos.node&this.offset==pos.offset},inspect:function(){return"[DomPosition("+inspectNode(this.node)+":"+this.offset+")]"}},DOMException.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11},DOMException.prototype.toString=function(){return this.message},api.dom={arrayContains:arrayContains,isHtmlNamespace:isHtmlNamespace,parentElement:parentElement,getNodeIndex:getNodeIndex,getNodeLength:getNodeLength,getCommonAncestor:getCommonAncestor,isAncestorOf:isAncestorOf,getClosestAncestorIn:getClosestAncestorIn,isCharacterDataNode:isCharacterDataNode,insertAfter:insertAfter,splitDataNode:splitDataNode,getDocument:getDocument,getWindow:getWindow,getIframeWindow:getIframeWindow,getIframeDocument:getIframeDocument,getBody:getBody,getRootContainer:getRootContainer,comparePoints:comparePoints,inspectNode:inspectNode,fragmentFromNodeChildren:fragmentFromNodeChildren,createIterator:createIterator,DomPosition:DomPosition},api.DOMException=DOMException}),rangy.createModule("DomRange",function(api){function isNonTextPartiallySelected(node,range){return 3!=node.nodeType&&(dom.isAncestorOf(node,range.startContainer,!0)||dom.isAncestorOf(node,range.endContainer,!0))}function getRangeDocument(range){return dom.getDocument(range.startContainer)}function dispatchEvent(range,type,args){var listeners=range._listeners[type];if(listeners)for(var i=0,len=listeners.length;len>i;++i)listeners[i].call(range,{target:range,args:args})}function getBoundaryBeforeNode(node){return new DomPosition(node.parentNode,dom.getNodeIndex(node))}function getBoundaryAfterNode(node){return new DomPosition(node.parentNode,dom.getNodeIndex(node)+1)}function insertNodeAtPosition(node,n,o){var firstNodeInserted=11==node.nodeType?node.firstChild:node;return dom.isCharacterDataNode(n)?o==n.length?dom.insertAfter(node,n):n.parentNode.insertBefore(node,0==o?n:dom.splitDataNode(n,o)):o>=n.childNodes.length?n.appendChild(node):n.insertBefore(node,n.childNodes[o]),firstNodeInserted}function cloneSubtree(iterator){for(var partiallySelected,node,subIterator,frag=getRangeDocument(iterator.range).createDocumentFragment();node=iterator.next();){if(partiallySelected=iterator.isPartiallySelectedSubtree(),node=node.cloneNode(!partiallySelected),partiallySelected&&(subIterator=iterator.getSubtreeIterator(),node.appendChild(cloneSubtree(subIterator)),subIterator.detach(!0)),10==node.nodeType)throw new DOMException("HIERARCHY_REQUEST_ERR");frag.appendChild(node)}return frag}function iterateSubtree(rangeIterator,func,iteratorState){var it,n;iteratorState=iteratorState||{stop:!1};for(var node,subRangeIterator;node=rangeIterator.next();)if(rangeIterator.isPartiallySelectedSubtree()){if(func(node)===!1)return iteratorState.stop=!0,void 0;if(subRangeIterator=rangeIterator.getSubtreeIterator(),iterateSubtree(subRangeIterator,func,iteratorState),subRangeIterator.detach(!0),iteratorState.stop)return}else for(it=dom.createIterator(node);n=it.next();)if(func(n)===!1)return iteratorState.stop=!0,void 0}function deleteSubtree(iterator){for(var subIterator;iterator.next();)iterator.isPartiallySelectedSubtree()?(subIterator=iterator.getSubtreeIterator(),deleteSubtree(subIterator),subIterator.detach(!0)):iterator.remove()}function extractSubtree(iterator){for(var node,subIterator,frag=getRangeDocument(iterator.range).createDocumentFragment();node=iterator.next();){if(iterator.isPartiallySelectedSubtree()?(node=node.cloneNode(!1),subIterator=iterator.getSubtreeIterator(),node.appendChild(extractSubtree(subIterator)),subIterator.detach(!0)):iterator.remove(),10==node.nodeType)throw new DOMException("HIERARCHY_REQUEST_ERR");frag.appendChild(node)}return frag}function getNodesInRange(range,nodeTypes,filter){var regex,filterNodeTypes=!(!nodeTypes||!nodeTypes.length),filterExists=!!filter;filterNodeTypes&&(regex=new RegExp("^("+nodeTypes.join("|")+")$"));var nodes=[];return iterateSubtree(new RangeIterator(range,!1),function(node){filterNodeTypes&&!regex.test(node.nodeType)||filterExists&&!filter(node)||nodes.push(node)}),nodes}function inspect(range){var name="undefined"==typeof range.getName?"Range":range.getName();return"["+name+"("+dom.inspectNode(range.startContainer)+":"+range.startOffset+", "+dom.inspectNode(range.endContainer)+":"+range.endOffset+")]"}function RangeIterator(range,clonePartiallySelectedTextNodes){if(this.range=range,this.clonePartiallySelectedTextNodes=clonePartiallySelectedTextNodes,!range.collapsed){this.sc=range.startContainer,this.so=range.startOffset,this.ec=range.endContainer,this.eo=range.endOffset;var root=range.commonAncestorContainer;this.sc===this.ec&&dom.isCharacterDataNode(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==root||dom.isCharacterDataNode(this.sc)?dom.getClosestAncestorIn(this.sc,root,!0):this.sc.childNodes[this.so],this._last=this.ec!==root||dom.isCharacterDataNode(this.ec)?dom.getClosestAncestorIn(this.ec,root,!0):this.ec.childNodes[this.eo-1])}}function RangeException(codeName){this.code=this[codeName],this.codeName=codeName,this.message="RangeException: "+this.codeName}function RangeNodeIterator(range,nodeTypes,filter){this.nodes=getNodesInRange(range,nodeTypes,filter),this._next=this.nodes[0],this._position=0}function createAncestorFinder(nodeTypes){return function(node,selfIsAncestor){for(var t,n=selfIsAncestor?node:node.parentNode;n;){if(t=n.nodeType,dom.arrayContains(nodeTypes,t))return n;n=n.parentNode}return null}}function assertNoDocTypeNotationEntityAncestor(node,allowSelf){if(getDocTypeNotationEntityAncestor(node,allowSelf))throw new RangeException("INVALID_NODE_TYPE_ERR")}function assertNotDetached(range){if(!range.startContainer)throw new DOMException("INVALID_STATE_ERR")}function assertValidNodeType(node,invalidTypes){if(!dom.arrayContains(invalidTypes,node.nodeType))throw new RangeException("INVALID_NODE_TYPE_ERR")}function assertValidOffset(node,offset){if(0>offset||offset>(dom.isCharacterDataNode(node)?node.length:node.childNodes.length))throw new DOMException("INDEX_SIZE_ERR")}function assertSameDocumentOrFragment(node1,node2){if(getDocumentOrFragmentContainer(node1,!0)!==getDocumentOrFragmentContainer(node2,!0))throw new DOMException("WRONG_DOCUMENT_ERR")}function assertNodeNotReadOnly(node){if(getReadonlyAncestor(node,!0))throw new DOMException("NO_MODIFICATION_ALLOWED_ERR")}function assertNode(node,codeName){if(!node)throw new DOMException(codeName)}function isOrphan(node){return!dom.arrayContains(rootContainerNodeTypes,node.nodeType)&&!getDocumentOrFragmentContainer(node,!0)}function isValidOffset(node,offset){return offset<=(dom.isCharacterDataNode(node)?node.length:node.childNodes.length)}function assertRangeValid(range){if(assertNotDetached(range),isOrphan(range.startContainer)||isOrphan(range.endContainer)||!isValidOffset(range.startContainer,range.startOffset)||!isValidOffset(range.endContainer,range.endOffset))throw new Error("Range error: Range is no longer valid after DOM mutation ("+range.inspect()+")")}function RangePrototype(){}function copyComparisonConstantsToObject(obj){obj.START_TO_START=s2s,obj.START_TO_END=s2e,obj.END_TO_END=e2e,obj.END_TO_START=e2s,obj.NODE_BEFORE=n_b,obj.NODE_AFTER=n_a,obj.NODE_BEFORE_AND_AFTER=n_b_a,obj.NODE_INSIDE=n_i}function copyComparisonConstants(constructor){copyComparisonConstantsToObject(constructor),copyComparisonConstantsToObject(constructor.prototype)}function createRangeContentRemover(remover,boundaryUpdater){return function(){assertRangeValid(this);var node,boundary,sc=this.startContainer,so=this.startOffset,root=this.commonAncestorContainer,iterator=new RangeIterator(this,!0);sc!==root&&(node=dom.getClosestAncestorIn(sc,root,!0),boundary=getBoundaryAfterNode(node),sc=boundary.node,so=boundary.offset),iterateSubtree(iterator,assertNodeNotReadOnly),iterator.reset();var returnValue=remover(iterator);return iterator.detach(),boundaryUpdater(this,sc,so,sc,so),returnValue}}function createPrototypeRange(constructor,boundaryUpdater,detacher){function createBeforeAfterNodeSetter(isBefore,isStart){return function(node){assertNotDetached(this),assertValidNodeType(node,beforeAfterNodeTypes),assertValidNodeType(getRootContainer(node),rootContainerNodeTypes);var boundary=(isBefore?getBoundaryBeforeNode:getBoundaryAfterNode)(node);(isStart?setRangeStart:setRangeEnd)(this,boundary.node,boundary.offset)}}function setRangeStart(range,node,offset){var ec=range.endContainer,eo=range.endOffset;(node!==range.startContainer||offset!==range.startOffset)&&((getRootContainer(node)!=getRootContainer(ec)||1==dom.comparePoints(node,offset,ec,eo))&&(ec=node,eo=offset),boundaryUpdater(range,node,offset,ec,eo))}function setRangeEnd(range,node,offset){var sc=range.startContainer,so=range.startOffset;(node!==range.endContainer||offset!==range.endOffset)&&((getRootContainer(node)!=getRootContainer(sc)||-1==dom.comparePoints(node,offset,sc,so))&&(sc=node,so=offset),boundaryUpdater(range,sc,so,node,offset))}function setRangeStartAndEnd(range,node,offset){(node!==range.startContainer||offset!==range.startOffset||node!==range.endContainer||offset!==range.endOffset)&&boundaryUpdater(range,node,offset,node,offset)}constructor.prototype=new RangePrototype,api.util.extend(constructor.prototype,{setStart:function(node,offset){assertNotDetached(this),assertNoDocTypeNotationEntityAncestor(node,!0),assertValidOffset(node,offset),setRangeStart(this,node,offset)},setEnd:function(node,offset){assertNotDetached(this),assertNoDocTypeNotationEntityAncestor(node,!0),assertValidOffset(node,offset),setRangeEnd(this,node,offset)},setStartBefore:createBeforeAfterNodeSetter(!0,!0),setStartAfter:createBeforeAfterNodeSetter(!1,!0),setEndBefore:createBeforeAfterNodeSetter(!0,!1),setEndAfter:createBeforeAfterNodeSetter(!1,!1),collapse:function(isStart){assertRangeValid(this),isStart?boundaryUpdater(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):boundaryUpdater(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(node){assertNotDetached(this),assertNoDocTypeNotationEntityAncestor(node,!0),boundaryUpdater(this,node,0,node,dom.getNodeLength(node))},selectNode:function(node){assertNotDetached(this),assertNoDocTypeNotationEntityAncestor(node,!1),assertValidNodeType(node,beforeAfterNodeTypes);var start=getBoundaryBeforeNode(node),end=getBoundaryAfterNode(node);boundaryUpdater(this,start.node,start.offset,end.node,end.offset)},extractContents:createRangeContentRemover(extractSubtree,boundaryUpdater),deleteContents:createRangeContentRemover(deleteSubtree,boundaryUpdater),canSurroundContents:function(){assertRangeValid(this),assertNodeNotReadOnly(this.startContainer),assertNodeNotReadOnly(this.endContainer);var iterator=new RangeIterator(this,!0),boundariesInvalid=iterator._first&&isNonTextPartiallySelected(iterator._first,this)||iterator._last&&isNonTextPartiallySelected(iterator._last,this);return iterator.detach(),!boundariesInvalid},detach:function(){detacher(this)},splitBoundaries:function(){assertRangeValid(this);var sc=this.startContainer,so=this.startOffset,ec=this.endContainer,eo=this.endOffset,startEndSame=sc===ec;dom.isCharacterDataNode(ec)&&eo>0&&eo<ec.length&&dom.splitDataNode(ec,eo),dom.isCharacterDataNode(sc)&&so>0&&so<sc.length&&(sc=dom.splitDataNode(sc,so),startEndSame?(eo-=so,ec=sc):ec==sc.parentNode&&eo>=dom.getNodeIndex(sc)&&eo++,so=0),boundaryUpdater(this,sc,so,ec,eo)},normalizeBoundaries:function(){assertRangeValid(this);var sc=this.startContainer,so=this.startOffset,ec=this.endContainer,eo=this.endOffset,mergeForward=function(node){var sibling=node.nextSibling;sibling&&sibling.nodeType==node.nodeType&&(ec=node,eo=node.length,node.appendData(sibling.data),sibling.parentNode.removeChild(sibling))},mergeBackward=function(node){var sibling=node.previousSibling;if(sibling&&sibling.nodeType==node.nodeType){sc=node;var nodeLength=node.length;if(so=sibling.length,node.insertData(0,sibling.data),sibling.parentNode.removeChild(sibling),sc==ec)eo+=so,ec=sc;else if(ec==node.parentNode){var nodeIndex=dom.getNodeIndex(node);eo==nodeIndex?(ec=node,eo=nodeLength):eo>nodeIndex&&eo--}}},normalizeStart=!0;if(dom.isCharacterDataNode(ec))ec.length==eo&&mergeForward(ec);else{if(eo>0){var endNode=ec.childNodes[eo-1];endNode&&dom.isCharacterDataNode(endNode)&&mergeForward(endNode)}normalizeStart=!this.collapsed}if(normalizeStart){if(dom.isCharacterDataNode(sc))0==so&&mergeBackward(sc);else if(so<sc.childNodes.length){var startNode=sc.childNodes[so];startNode&&dom.isCharacterDataNode(startNode)&&mergeBackward(startNode)}}else sc=ec,so=eo;boundaryUpdater(this,sc,so,ec,eo)},collapseToPoint:function(node,offset){assertNotDetached(this),assertNoDocTypeNotationEntityAncestor(node,!0),assertValidOffset(node,offset),setRangeStartAndEnd(this,node,offset)}}),copyComparisonConstants(constructor)}function updateCollapsedAndCommonAncestor(range){range.collapsed=range.startContainer===range.endContainer&&range.startOffset===range.endOffset,range.commonAncestorContainer=range.collapsed?range.startContainer:dom.getCommonAncestor(range.startContainer,range.endContainer)}function updateBoundaries(range,startContainer,startOffset,endContainer,endOffset){var startMoved=range.startContainer!==startContainer||range.startOffset!==startOffset,endMoved=range.endContainer!==endContainer||range.endOffset!==endOffset;range.startContainer=startContainer,range.startOffset=startOffset,range.endContainer=endContainer,range.endOffset=endOffset,updateCollapsedAndCommonAncestor(range),dispatchEvent(range,"boundarychange",{startMoved:startMoved,endMoved:endMoved})}function detach(range){assertNotDetached(range),range.startContainer=range.startOffset=range.endContainer=range.endOffset=null,range.collapsed=range.commonAncestorContainer=null,dispatchEvent(range,"detach",null),range._listeners=null}function Range(doc){this.startContainer=doc,this.startOffset=0,this.endContainer=doc,this.endOffset=0,this._listeners={boundarychange:[],detach:[]},updateCollapsedAndCommonAncestor(this)}api.requireModules(["DomUtil"]);var dom=api.dom,DomPosition=dom.DomPosition,DOMException=api.DOMException;RangeIterator.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var current=this._current=this._next;return current&&(this._next=current!==this._last?current.nextSibling:null,dom.isCharacterDataNode(current)&&this.clonePartiallySelectedTextNodes&&(current===this.ec&&(current=current.cloneNode(!0)).deleteData(this.eo,current.length-this.eo),this._current===this.sc&&(current=current.cloneNode(!0)).deleteData(0,this.so))),current},remove:function(){var start,end,current=this._current;!dom.isCharacterDataNode(current)||current!==this.sc&&current!==this.ec?current.parentNode&&current.parentNode.removeChild(current):(start=current===this.sc?this.so:0,end=current===this.ec?this.eo:current.length,start!=end&&current.deleteData(start,end-start))},isPartiallySelectedSubtree:function(){var current=this._current;return isNonTextPartiallySelected(current,this.range)},getSubtreeIterator:function(){var subRange;if(this.isSingleCharacterDataNode)subRange=this.range.cloneRange(),subRange.collapse();else{subRange=new Range(getRangeDocument(this.range));var current=this._current,startContainer=current,startOffset=0,endContainer=current,endOffset=dom.getNodeLength(current);dom.isAncestorOf(current,this.sc,!0)&&(startContainer=this.sc,startOffset=this.so),dom.isAncestorOf(current,this.ec,!0)&&(endContainer=this.ec,endOffset=this.eo),updateBoundaries(subRange,startContainer,startOffset,endContainer,endOffset)}return new RangeIterator(subRange,this.clonePartiallySelectedTextNodes)},detach:function(detachRange){detachRange&&this.range.detach(),this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}},RangeException.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2},RangeException.prototype.toString=function(){return this.message},RangeNodeIterator.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){return this._current=this._next,this._next=this.nodes[++this._position],this._current},detach:function(){this._current=this._next=this.nodes=null}};var beforeAfterNodeTypes=[1,3,4,5,7,8,10],rootContainerNodeTypes=[2,9,11],readonlyNodeTypes=[5,6,10,12],insertableNodeTypes=[1,3,4,5,7,8,10,11],surroundNodeTypes=[1,3,4,5,7,8],getRootContainer=dom.getRootContainer,getDocumentOrFragmentContainer=createAncestorFinder([9,11]),getReadonlyAncestor=createAncestorFinder(readonlyNodeTypes),getDocTypeNotationEntityAncestor=createAncestorFinder([6,10,12]),styleEl=document.createElement("style"),htmlParsingConforms=!1;try{styleEl.innerHTML="<b>x</b>",htmlParsingConforms=3==styleEl.firstChild.nodeType}catch(e){}api.features.htmlParsingConforms=htmlParsingConforms;var createContextualFragment=htmlParsingConforms?function(fragmentStr){var node=this.startContainer,doc=dom.getDocument(node);if(!node)throw new DOMException("INVALID_STATE_ERR");var el=null;return 1==node.nodeType?el=node:dom.isCharacterDataNode(node)&&(el=dom.parentElement(node)),el=null===el||"HTML"==el.nodeName&&dom.isHtmlNamespace(dom.getDocument(el).documentElement)&&dom.isHtmlNamespace(el)?doc.createElement("body"):el.cloneNode(!1),el.innerHTML=fragmentStr,dom.fragmentFromNodeChildren(el)}:function(fragmentStr){assertNotDetached(this);var doc=getRangeDocument(this),el=doc.createElement("body");return el.innerHTML=fragmentStr,dom.fragmentFromNodeChildren(el)},rangeProperties=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],s2s=0,s2e=1,e2e=2,e2s=3,n_b=0,n_a=1,n_b_a=2,n_i=3;RangePrototype.prototype={attachListener:function(type,listener){this._listeners[type].push(listener)},compareBoundaryPoints:function(how,range){assertRangeValid(this),assertSameDocumentOrFragment(this.startContainer,range.startContainer);var nodeA,offsetA,nodeB,offsetB,prefixA=how==e2s||how==s2s?"start":"end",prefixB=how==s2e||how==s2s?"start":"end";return nodeA=this[prefixA+"Container"],offsetA=this[prefixA+"Offset"],nodeB=range[prefixB+"Container"],offsetB=range[prefixB+"Offset"],dom.comparePoints(nodeA,offsetA,nodeB,offsetB)},insertNode:function(node){if(assertRangeValid(this),assertValidNodeType(node,insertableNodeTypes),assertNodeNotReadOnly(this.startContainer),dom.isAncestorOf(node,this.startContainer,!0))throw new DOMException("HIERARCHY_REQUEST_ERR");var firstNodeInserted=insertNodeAtPosition(node,this.startContainer,this.startOffset);this.setStartBefore(firstNodeInserted)},cloneContents:function(){assertRangeValid(this);var clone,frag;if(this.collapsed)return getRangeDocument(this).createDocumentFragment();if(this.startContainer===this.endContainer&&dom.isCharacterDataNode(this.startContainer))return clone=this.startContainer.cloneNode(!0),clone.data=clone.data.slice(this.startOffset,this.endOffset),frag=getRangeDocument(this).createDocumentFragment(),frag.appendChild(clone),frag;var iterator=new RangeIterator(this,!0);return clone=cloneSubtree(iterator),iterator.detach(),clone},canSurroundContents:function(){assertRangeValid(this),assertNodeNotReadOnly(this.startContainer),assertNodeNotReadOnly(this.endContainer);var iterator=new RangeIterator(this,!0),boundariesInvalid=iterator._first&&isNonTextPartiallySelected(iterator._first,this)||iterator._last&&isNonTextPartiallySelected(iterator._last,this);return iterator.detach(),!boundariesInvalid},surroundContents:function(node){if(assertValidNodeType(node,surroundNodeTypes),!this.canSurroundContents())throw new RangeException("BAD_BOUNDARYPOINTS_ERR");var content=this.extractContents();if(node.hasChildNodes())for(;node.lastChild;)node.removeChild(node.lastChild);insertNodeAtPosition(node,this.startContainer,this.startOffset),node.appendChild(content),this.selectNode(node)},cloneRange:function(){assertRangeValid(this);for(var prop,range=new Range(getRangeDocument(this)),i=rangeProperties.length;i--;)prop=rangeProperties[i],range[prop]=this[prop];return range},toString:function(){assertRangeValid(this);var sc=this.startContainer;if(sc===this.endContainer&&dom.isCharacterDataNode(sc))return 3==sc.nodeType||4==sc.nodeType?sc.data.slice(this.startOffset,this.endOffset):"";var textBits=[],iterator=new RangeIterator(this,!0);return iterateSubtree(iterator,function(node){(3==node.nodeType||4==node.nodeType)&&textBits.push(node.data)}),iterator.detach(),textBits.join("")},compareNode:function(node){assertRangeValid(this);var parent=node.parentNode,nodeIndex=dom.getNodeIndex(node);if(!parent)throw new DOMException("NOT_FOUND_ERR");var startComparison=this.comparePoint(parent,nodeIndex),endComparison=this.comparePoint(parent,nodeIndex+1);return 0>startComparison?endComparison>0?n_b_a:n_b:endComparison>0?n_a:n_i},comparePoint:function(node,offset){return assertRangeValid(this),assertNode(node,"HIERARCHY_REQUEST_ERR"),assertSameDocumentOrFragment(node,this.startContainer),dom.comparePoints(node,offset,this.startContainer,this.startOffset)<0?-1:dom.comparePoints(node,offset,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:createContextualFragment,toHtml:function(){assertRangeValid(this);var container=getRangeDocument(this).createElement("div");return container.appendChild(this.cloneContents()),container.innerHTML},intersectsNode:function(node,touchingIsIntersecting){if(assertRangeValid(this),assertNode(node,"NOT_FOUND_ERR"),dom.getDocument(node)!==getRangeDocument(this))return!1;var parent=node.parentNode,offset=dom.getNodeIndex(node);assertNode(parent,"NOT_FOUND_ERR");var startComparison=dom.comparePoints(parent,offset,this.endContainer,this.endOffset),endComparison=dom.comparePoints(parent,offset+1,this.startContainer,this.startOffset);
return touchingIsIntersecting?0>=startComparison&&endComparison>=0:0>startComparison&&endComparison>0},isPointInRange:function(node,offset){return assertRangeValid(this),assertNode(node,"HIERARCHY_REQUEST_ERR"),assertSameDocumentOrFragment(node,this.startContainer),dom.comparePoints(node,offset,this.startContainer,this.startOffset)>=0&&dom.comparePoints(node,offset,this.endContainer,this.endOffset)<=0},intersectsRange:function(range,touchingIsIntersecting){if(assertRangeValid(this),getRangeDocument(range)!=getRangeDocument(this))throw new DOMException("WRONG_DOCUMENT_ERR");var startComparison=dom.comparePoints(this.startContainer,this.startOffset,range.endContainer,range.endOffset),endComparison=dom.comparePoints(this.endContainer,this.endOffset,range.startContainer,range.startOffset);return touchingIsIntersecting?0>=startComparison&&endComparison>=0:0>startComparison&&endComparison>0},intersection:function(range){if(this.intersectsRange(range)){var startComparison=dom.comparePoints(this.startContainer,this.startOffset,range.startContainer,range.startOffset),endComparison=dom.comparePoints(this.endContainer,this.endOffset,range.endContainer,range.endOffset),intersectionRange=this.cloneRange();return-1==startComparison&&intersectionRange.setStart(range.startContainer,range.startOffset),1==endComparison&&intersectionRange.setEnd(range.endContainer,range.endOffset),intersectionRange}return null},union:function(range){if(this.intersectsRange(range,!0)){var unionRange=this.cloneRange();return-1==dom.comparePoints(range.startContainer,range.startOffset,this.startContainer,this.startOffset)&&unionRange.setStart(range.startContainer,range.startOffset),1==dom.comparePoints(range.endContainer,range.endOffset,this.endContainer,this.endOffset)&&unionRange.setEnd(range.endContainer,range.endOffset),unionRange}throw new RangeException("Ranges do not intersect")},containsNode:function(node,allowPartial){return allowPartial?this.intersectsNode(node,!1):this.compareNode(node)==n_i},containsNodeContents:function(node){return this.comparePoint(node,0)>=0&&this.comparePoint(node,dom.getNodeLength(node))<=0},containsRange:function(range){return this.intersection(range).equals(range)},containsNodeText:function(node){var nodeRange=this.cloneRange();nodeRange.selectNode(node);var textNodes=nodeRange.getNodes([3]);if(textNodes.length>0){nodeRange.setStart(textNodes[0],0);var lastTextNode=textNodes.pop();nodeRange.setEnd(lastTextNode,lastTextNode.length);var contains=this.containsRange(nodeRange);return nodeRange.detach(),contains}return this.containsNodeContents(node)},createNodeIterator:function(nodeTypes,filter){return assertRangeValid(this),new RangeNodeIterator(this,nodeTypes,filter)},getNodes:function(nodeTypes,filter){return assertRangeValid(this),getNodesInRange(this,nodeTypes,filter)},getDocument:function(){return getRangeDocument(this)},collapseBefore:function(node){assertNotDetached(this),this.setEndBefore(node),this.collapse(!1)},collapseAfter:function(node){assertNotDetached(this),this.setStartAfter(node),this.collapse(!0)},getName:function(){return"DomRange"},equals:function(range){return Range.rangesEqual(this,range)},inspect:function(){return inspect(this)}},createPrototypeRange(Range,updateBoundaries,detach),api.rangePrototype=RangePrototype.prototype,Range.rangeProperties=rangeProperties,Range.RangeIterator=RangeIterator,Range.copyComparisonConstants=copyComparisonConstants,Range.createPrototypeRange=createPrototypeRange,Range.inspect=inspect,Range.getRangeDocument=getRangeDocument,Range.rangesEqual=function(r1,r2){return r1.startContainer===r2.startContainer&&r1.startOffset===r2.startOffset&&r1.endContainer===r2.endContainer&&r1.endOffset===r2.endOffset},api.DomRange=Range,api.RangeException=RangeException}),rangy.createModule("WrappedRange",function(api){function getTextRangeContainerElement(textRange){var parentEl=textRange.parentElement(),range=textRange.duplicate();range.collapse(!0);var startEl=range.parentElement();range=textRange.duplicate(),range.collapse(!1);var endEl=range.parentElement(),startEndContainer=startEl==endEl?startEl:dom.getCommonAncestor(startEl,endEl);return startEndContainer==parentEl?startEndContainer:dom.getCommonAncestor(parentEl,startEndContainer)}function textRangeIsCollapsed(textRange){return 0==textRange.compareEndPoints("StartToEnd",textRange)}function getTextRangeBoundaryPosition(textRange,wholeRangeContainerElement,isStart,isCollapsed){var workingRange=textRange.duplicate();workingRange.collapse(isStart);var containerElement=workingRange.parentElement();if(dom.isAncestorOf(wholeRangeContainerElement,containerElement,!0)||(containerElement=wholeRangeContainerElement),!containerElement.canHaveHTML)return new DomPosition(containerElement.parentNode,dom.getNodeIndex(containerElement));var comparison,previousNode,nextNode,boundaryPosition,boundaryNode,workingNode=dom.getDocument(containerElement).createElement("span"),workingComparisonType=isStart?"StartToStart":"StartToEnd";do containerElement.insertBefore(workingNode,workingNode.previousSibling),workingRange.moveToElementText(workingNode);while((comparison=workingRange.compareEndPoints(workingComparisonType,textRange))>0&&workingNode.previousSibling);if(boundaryNode=workingNode.nextSibling,-1==comparison&&boundaryNode&&dom.isCharacterDataNode(boundaryNode)){workingRange.setEndPoint(isStart?"EndToStart":"EndToEnd",textRange);var offset;if(/[\r\n]/.test(boundaryNode.data)){var tempRange=workingRange.duplicate(),rangeLength=tempRange.text.replace(/\r\n/g,"\r").length;for(offset=tempRange.moveStart("character",rangeLength);-1==(comparison=tempRange.compareEndPoints("StartToEnd",tempRange));)offset++,tempRange.moveStart("character",1)}else offset=workingRange.text.length;boundaryPosition=new DomPosition(boundaryNode,offset)}else previousNode=(isCollapsed||!isStart)&&workingNode.previousSibling,nextNode=(isCollapsed||isStart)&&workingNode.nextSibling,boundaryPosition=nextNode&&dom.isCharacterDataNode(nextNode)?new DomPosition(nextNode,0):previousNode&&dom.isCharacterDataNode(previousNode)?new DomPosition(previousNode,previousNode.length):new DomPosition(containerElement,dom.getNodeIndex(workingNode));return workingNode.parentNode.removeChild(workingNode),boundaryPosition}function createBoundaryTextRange(boundaryPosition,isStart){var boundaryNode,boundaryParent,workingNode,childNodes,boundaryOffset=boundaryPosition.offset,doc=dom.getDocument(boundaryPosition.node),workingRange=doc.body.createTextRange(),nodeIsDataNode=dom.isCharacterDataNode(boundaryPosition.node);return nodeIsDataNode?(boundaryNode=boundaryPosition.node,boundaryParent=boundaryNode.parentNode):(childNodes=boundaryPosition.node.childNodes,boundaryNode=boundaryOffset<childNodes.length?childNodes[boundaryOffset]:null,boundaryParent=boundaryPosition.node),workingNode=doc.createElement("span"),workingNode.innerHTML="&#feff;",boundaryNode?boundaryParent.insertBefore(workingNode,boundaryNode):boundaryParent.appendChild(workingNode),workingRange.moveToElementText(workingNode),workingRange.collapse(!isStart),boundaryParent.removeChild(workingNode),nodeIsDataNode&&workingRange[isStart?"moveStart":"moveEnd"]("character",boundaryOffset),workingRange}api.requireModules(["DomUtil","DomRange"]);var WrappedRange,dom=api.dom,DomPosition=dom.DomPosition,DomRange=api.DomRange;if(!api.features.implementsDomRange||api.features.implementsTextRange&&api.config.preferTextRange){if(api.features.implementsTextRange){WrappedRange=function(textRange){this.textRange=textRange,this.refresh()},WrappedRange.prototype=new DomRange(document),WrappedRange.prototype.refresh=function(){var start,end,rangeContainerElement=getTextRangeContainerElement(this.textRange);textRangeIsCollapsed(this.textRange)?end=start=getTextRangeBoundaryPosition(this.textRange,rangeContainerElement,!0,!0):(start=getTextRangeBoundaryPosition(this.textRange,rangeContainerElement,!0,!1),end=getTextRangeBoundaryPosition(this.textRange,rangeContainerElement,!1,!1)),this.setStart(start.node,start.offset),this.setEnd(end.node,end.offset)},DomRange.copyComparisonConstants(WrappedRange);var globalObj=function(){return this}();"undefined"==typeof globalObj.Range&&(globalObj.Range=WrappedRange),api.createNativeRange=function(doc){return doc=doc||document,doc.body.createTextRange()}}}else!function(){function updateRangeProperties(range){for(var prop,i=rangeProperties.length;i--;)prop=rangeProperties[i],range[prop]=range.nativeRange[prop]}function updateNativeRange(range,startContainer,startOffset,endContainer,endOffset){var startMoved=range.startContainer!==startContainer||range.startOffset!=startOffset,endMoved=range.endContainer!==endContainer||range.endOffset!=endOffset;(startMoved||endMoved)&&(range.setEnd(endContainer,endOffset),range.setStart(startContainer,startOffset))}function detach(range){range.nativeRange.detach(),range.detached=!0;for(var prop,i=rangeProperties.length;i--;)prop=rangeProperties[i],range[prop]=null}var rangeProto,canSetRangeStartAfterEnd,createBeforeAfterNodeSetter,rangeProperties=DomRange.rangeProperties;WrappedRange=function(range){if(!range)throw new Error("Range must be specified");this.nativeRange=range,updateRangeProperties(this)},DomRange.createPrototypeRange(WrappedRange,updateNativeRange,detach),rangeProto=WrappedRange.prototype,rangeProto.selectNode=function(node){this.nativeRange.selectNode(node),updateRangeProperties(this)},rangeProto.deleteContents=function(){this.nativeRange.deleteContents(),updateRangeProperties(this)},rangeProto.extractContents=function(){var frag=this.nativeRange.extractContents();return updateRangeProperties(this),frag},rangeProto.cloneContents=function(){return this.nativeRange.cloneContents()},rangeProto.surroundContents=function(node){this.nativeRange.surroundContents(node),updateRangeProperties(this)},rangeProto.collapse=function(isStart){this.nativeRange.collapse(isStart),updateRangeProperties(this)},rangeProto.cloneRange=function(){return new WrappedRange(this.nativeRange.cloneRange())},rangeProto.refresh=function(){updateRangeProperties(this)},rangeProto.toString=function(){return this.nativeRange.toString()};var testTextNode=document.createTextNode("test");dom.getBody(document).appendChild(testTextNode);var range=document.createRange();range.setStart(testTextNode,0),range.setEnd(testTextNode,0);try{range.setStart(testTextNode,1),canSetRangeStartAfterEnd=!0,rangeProto.setStart=function(node,offset){this.nativeRange.setStart(node,offset),updateRangeProperties(this)},rangeProto.setEnd=function(node,offset){this.nativeRange.setEnd(node,offset),updateRangeProperties(this)},createBeforeAfterNodeSetter=function(name){return function(node){this.nativeRange[name](node),updateRangeProperties(this)}}}catch(ex){canSetRangeStartAfterEnd=!1,rangeProto.setStart=function(node,offset){try{this.nativeRange.setStart(node,offset)}catch(ex){this.nativeRange.setEnd(node,offset),this.nativeRange.setStart(node,offset)}updateRangeProperties(this)},rangeProto.setEnd=function(node,offset){try{this.nativeRange.setEnd(node,offset)}catch(ex){this.nativeRange.setStart(node,offset),this.nativeRange.setEnd(node,offset)}updateRangeProperties(this)},createBeforeAfterNodeSetter=function(name,oppositeName){return function(node){try{this.nativeRange[name](node)}catch(ex){this.nativeRange[oppositeName](node),this.nativeRange[name](node)}updateRangeProperties(this)}}}rangeProto.setStartBefore=createBeforeAfterNodeSetter("setStartBefore","setEndBefore"),rangeProto.setStartAfter=createBeforeAfterNodeSetter("setStartAfter","setEndAfter"),rangeProto.setEndBefore=createBeforeAfterNodeSetter("setEndBefore","setStartBefore"),rangeProto.setEndAfter=createBeforeAfterNodeSetter("setEndAfter","setStartAfter"),range.selectNodeContents(testTextNode),rangeProto.selectNodeContents=range.startContainer==testTextNode&&range.endContainer==testTextNode&&0==range.startOffset&&range.endOffset==testTextNode.length?function(node){this.nativeRange.selectNodeContents(node),updateRangeProperties(this)}:function(node){this.setStart(node,0),this.setEnd(node,DomRange.getEndOffset(node))},range.selectNodeContents(testTextNode),range.setEnd(testTextNode,3);var range2=document.createRange();range2.selectNodeContents(testTextNode),range2.setEnd(testTextNode,4),range2.setStart(testTextNode,2),rangeProto.compareBoundaryPoints=-1==range.compareBoundaryPoints(range.START_TO_END,range2)&1==range.compareBoundaryPoints(range.END_TO_START,range2)?function(type,range){return range=range.nativeRange||range,type==range.START_TO_END?type=range.END_TO_START:type==range.END_TO_START&&(type=range.START_TO_END),this.nativeRange.compareBoundaryPoints(type,range)}:function(type,range){return this.nativeRange.compareBoundaryPoints(type,range.nativeRange||range)},api.util.isHostMethod(range,"createContextualFragment")&&(rangeProto.createContextualFragment=function(fragmentStr){return this.nativeRange.createContextualFragment(fragmentStr)}),dom.getBody(document).removeChild(testTextNode),range.detach(),range2.detach()}(),api.createNativeRange=function(doc){return doc=doc||document,doc.createRange()};api.features.implementsTextRange&&(WrappedRange.rangeToTextRange=function(range){if(range.collapsed){var tr=createBoundaryTextRange(new DomPosition(range.startContainer,range.startOffset),!0);return tr}var startRange=createBoundaryTextRange(new DomPosition(range.startContainer,range.startOffset),!0),endRange=createBoundaryTextRange(new DomPosition(range.endContainer,range.endOffset),!1),textRange=dom.getDocument(range.startContainer).body.createTextRange();return textRange.setEndPoint("StartToStart",startRange),textRange.setEndPoint("EndToEnd",endRange),textRange}),WrappedRange.prototype.getName=function(){return"WrappedRange"},api.WrappedRange=WrappedRange,api.createRange=function(doc){return doc=doc||document,new WrappedRange(api.createNativeRange(doc))},api.createRangyRange=function(doc){return doc=doc||document,new DomRange(doc)},api.createIframeRange=function(iframeEl){return api.createRange(dom.getIframeDocument(iframeEl))},api.createIframeRangyRange=function(iframeEl){return api.createRangyRange(dom.getIframeDocument(iframeEl))},api.addCreateMissingNativeApiListener(function(win){var doc=win.document;"undefined"==typeof doc.createRange&&(doc.createRange=function(){return api.createRange(this)}),doc=win=null})}),rangy.createModule("WrappedSelection",function(api,module){function getWinSelection(winParam){return(winParam||window).getSelection()}function getDocSelection(winParam){return(winParam||window).document.selection}function updateAnchorAndFocusFromRange(sel,range,backwards){var anchorPrefix=backwards?"end":"start",focusPrefix=backwards?"start":"end";sel.anchorNode=range[anchorPrefix+"Container"],sel.anchorOffset=range[anchorPrefix+"Offset"],sel.focusNode=range[focusPrefix+"Container"],sel.focusOffset=range[focusPrefix+"Offset"]}function updateAnchorAndFocusFromNativeSelection(sel){var nativeSel=sel.nativeSelection;sel.anchorNode=nativeSel.anchorNode,sel.anchorOffset=nativeSel.anchorOffset,sel.focusNode=nativeSel.focusNode,sel.focusOffset=nativeSel.focusOffset}function updateEmptySelection(sel){sel.anchorNode=sel.focusNode=null,sel.anchorOffset=sel.focusOffset=0,sel.rangeCount=0,sel.isCollapsed=!0,sel._ranges.length=0}function getNativeRange(range){var nativeRange;return range instanceof DomRange?(nativeRange=range._selectionNativeRange,nativeRange||(nativeRange=api.createNativeRange(dom.getDocument(range.startContainer)),nativeRange.setEnd(range.endContainer,range.endOffset),nativeRange.setStart(range.startContainer,range.startOffset),range._selectionNativeRange=nativeRange,range.attachListener("detach",function(){this._selectionNativeRange=null}))):range instanceof WrappedRange?nativeRange=range.nativeRange:api.features.implementsDomRange&&range instanceof dom.getWindow(range.startContainer).Range&&(nativeRange=range),nativeRange}function rangeContainsSingleElement(rangeNodes){if(!rangeNodes.length||1!=rangeNodes[0].nodeType)return!1;for(var i=1,len=rangeNodes.length;len>i;++i)if(!dom.isAncestorOf(rangeNodes[0],rangeNodes[i]))return!1;return!0}function getSingleElementFromRange(range){var nodes=range.getNodes();if(!rangeContainsSingleElement(nodes))throw new Error("getSingleElementFromRange: range "+range.inspect()+" did not consist of a single element");return nodes[0]}function isTextRange(range){return!!range&&"undefined"!=typeof range.text}function updateFromTextRange(sel,range){var wrappedRange=new WrappedRange(range);sel._ranges=[wrappedRange],updateAnchorAndFocusFromRange(sel,wrappedRange,!1),sel.rangeCount=1,sel.isCollapsed=wrappedRange.collapsed}function updateControlSelection(sel){if(sel._ranges.length=0,"None"==sel.docSelection.type)updateEmptySelection(sel);else{var controlRange=sel.docSelection.createRange();if(isTextRange(controlRange))updateFromTextRange(sel,controlRange);else{sel.rangeCount=controlRange.length;for(var range,doc=dom.getDocument(controlRange.item(0)),i=0;i<sel.rangeCount;++i)range=api.createRange(doc),range.selectNode(controlRange.item(i)),sel._ranges.push(range);sel.isCollapsed=1==sel.rangeCount&&sel._ranges[0].collapsed,updateAnchorAndFocusFromRange(sel,sel._ranges[sel.rangeCount-1],!1)}}}function addRangeToControlSelection(sel,range){for(var controlRange=sel.docSelection.createRange(),rangeElement=getSingleElementFromRange(range),doc=dom.getDocument(controlRange.item(0)),newControlRange=dom.getBody(doc).createControlRange(),i=0,len=controlRange.length;len>i;++i)newControlRange.add(controlRange.item(i));try{newControlRange.add(rangeElement)}catch(ex){throw new Error("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}newControlRange.select(),updateControlSelection(sel)}function WrappedSelection(selection,docSelection,win){this.nativeSelection=selection,this.docSelection=docSelection,this._ranges=[],this.win=win,this.refresh()}function createControlSelection(sel,ranges){for(var el,doc=dom.getDocument(ranges[0].startContainer),controlRange=dom.getBody(doc).createControlRange(),i=0;rangeCount>i;++i){el=getSingleElementFromRange(ranges[i]);try{controlRange.add(el)}catch(ex){throw new Error("setRanges(): Element within the one of the specified Ranges could not be added to control selection (does it have layout?)")}}controlRange.select(),updateControlSelection(sel)}function assertNodeInSameDocument(sel,node){if(sel.anchorNode&&dom.getDocument(sel.anchorNode)!==dom.getDocument(node))throw new DOMException("WRONG_DOCUMENT_ERR")}function inspect(sel){var rangeInspects=[],anchor=new DomPosition(sel.anchorNode,sel.anchorOffset),focus=new DomPosition(sel.focusNode,sel.focusOffset),name="function"==typeof sel.getName?sel.getName():"Selection";if("undefined"!=typeof sel.rangeCount)for(var i=0,len=sel.rangeCount;len>i;++i)rangeInspects[i]=DomRange.inspect(sel.getRangeAt(i));return"["+name+"(Ranges: "+rangeInspects.join(", ")+")(anchor: "+anchor.inspect()+", focus: "+focus.inspect()+"]"}api.requireModules(["DomUtil","DomRange","WrappedRange"]),api.config.checkSelectionRanges=!0;var getSelection,selectionIsCollapsed,BOOLEAN="boolean",windowPropertyName="_rangySelection",dom=api.dom,util=api.util,DomRange=api.DomRange,WrappedRange=api.WrappedRange,DOMException=api.DOMException,DomPosition=dom.DomPosition,CONTROL="Control",implementsWinGetSelection=api.util.isHostMethod(window,"getSelection"),implementsDocSelection=api.util.isHostObject(document,"selection"),useDocumentSelection=implementsDocSelection&&(!implementsWinGetSelection||api.config.preferTextRange);useDocumentSelection?(getSelection=getDocSelection,api.isSelectionValid=function(winParam){var doc=(winParam||window).document,nativeSel=doc.selection;return"None"!=nativeSel.type||dom.getDocument(nativeSel.createRange().parentElement())==doc}):implementsWinGetSelection?(getSelection=getWinSelection,api.isSelectionValid=function(){return!0}):module.fail("Neither document.selection or window.getSelection() detected."),api.getNativeSelection=getSelection;var testSelection=getSelection(),testRange=api.createNativeRange(document),body=dom.getBody(document),selectionHasAnchorAndFocus=util.areHostObjects(testSelection,["anchorNode","focusNode"]&&util.areHostProperties(testSelection,["anchorOffset","focusOffset"]));api.features.selectionHasAnchorAndFocus=selectionHasAnchorAndFocus;var selectionHasExtend=util.isHostMethod(testSelection,"extend");api.features.selectionHasExtend=selectionHasExtend;var selectionHasRangeCount="number"==typeof testSelection.rangeCount;api.features.selectionHasRangeCount=selectionHasRangeCount;var selectionSupportsMultipleRanges=!1,collapsedNonEditableSelectionsSupported=!0;util.areHostMethods(testSelection,["addRange","getRangeAt","removeAllRanges"])&&"number"==typeof testSelection.rangeCount&&api.features.implementsDomRange&&function(){var iframe=document.createElement("iframe");body.appendChild(iframe);var iframeDoc=dom.getIframeDocument(iframe);iframeDoc.open(),iframeDoc.write("<html><head></head><body>12</body></html>"),iframeDoc.close();var sel=dom.getIframeWindow(iframe).getSelection(),docEl=iframeDoc.documentElement,iframeBody=docEl.lastChild,textNode=iframeBody.firstChild,r1=iframeDoc.createRange();r1.setStart(textNode,1),r1.collapse(!0),sel.addRange(r1),collapsedNonEditableSelectionsSupported=1==sel.rangeCount,sel.removeAllRanges();var r2=r1.cloneRange();r1.setStart(textNode,0),r2.setEnd(textNode,2),sel.addRange(r1),sel.addRange(r2),selectionSupportsMultipleRanges=2==sel.rangeCount,r1.detach(),r2.detach(),body.removeChild(iframe)}(),api.features.selectionSupportsMultipleRanges=selectionSupportsMultipleRanges,api.features.collapsedNonEditableSelectionsSupported=collapsedNonEditableSelectionsSupported;var testControlRange,implementsControlRange=!1;body&&util.isHostMethod(body,"createControlRange")&&(testControlRange=body.createControlRange(),util.areHostProperties(testControlRange,["item","add"])&&(implementsControlRange=!0)),api.features.implementsControlRange=implementsControlRange,selectionIsCollapsed=selectionHasAnchorAndFocus?function(sel){return sel.anchorNode===sel.focusNode&&sel.anchorOffset===sel.focusOffset}:function(sel){return sel.rangeCount?sel.getRangeAt(sel.rangeCount-1).collapsed:!1};var getSelectionRangeAt;util.isHostMethod(testSelection,"getRangeAt")?getSelectionRangeAt=function(sel,index){try{return sel.getRangeAt(index)}catch(ex){return null}}:selectionHasAnchorAndFocus&&(getSelectionRangeAt=function(sel){var doc=dom.getDocument(sel.anchorNode),range=api.createRange(doc);return range.setStart(sel.anchorNode,sel.anchorOffset),range.setEnd(sel.focusNode,sel.focusOffset),range.collapsed!==this.isCollapsed&&(range.setStart(sel.focusNode,sel.focusOffset),range.setEnd(sel.anchorNode,sel.anchorOffset)),range}),api.getSelection=function(win){win=win||window;var sel=win[windowPropertyName],nativeSel=getSelection(win),docSel=implementsDocSelection?getDocSelection(win):null;return sel?(sel.nativeSelection=nativeSel,sel.docSelection=docSel,sel.refresh(win)):(sel=new WrappedSelection(nativeSel,docSel,win),win[windowPropertyName]=sel),sel},api.getIframeSelection=function(iframeEl){return api.getSelection(dom.getIframeWindow(iframeEl))};var selProto=WrappedSelection.prototype;if(!useDocumentSelection&&selectionHasAnchorAndFocus&&util.areHostMethods(testSelection,["removeAllRanges","addRange"])){selProto.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),updateEmptySelection(this)};var addRangeBackwards=function(sel,range){var doc=DomRange.getRangeDocument(range),endRange=api.createRange(doc);endRange.collapseToPoint(range.endContainer,range.endOffset),sel.nativeSelection.addRange(getNativeRange(endRange)),sel.nativeSelection.extend(range.startContainer,range.startOffset),sel.refresh()};selProto.addRange=selectionHasRangeCount?function(range,backwards){if(implementsControlRange&&implementsDocSelection&&this.docSelection.type==CONTROL)addRangeToControlSelection(this,range);else if(backwards&&selectionHasExtend)addRangeBackwards(this,range);else{var previousRangeCount;if(selectionSupportsMultipleRanges?previousRangeCount=this.rangeCount:(this.removeAllRanges(),previousRangeCount=0),this.nativeSelection.addRange(getNativeRange(range)),this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==previousRangeCount+1){if(api.config.checkSelectionRanges){var nativeRange=getSelectionRangeAt(this.nativeSelection,this.rangeCount-1);nativeRange&&!DomRange.rangesEqual(nativeRange,range)&&(range=new WrappedRange(nativeRange))}this._ranges[this.rangeCount-1]=range,updateAnchorAndFocusFromRange(this,range,selectionIsBackwards(this.nativeSelection)),this.isCollapsed=selectionIsCollapsed(this)}else this.refresh()}}:function(range,backwards){backwards&&selectionHasExtend?addRangeBackwards(this,range):(this.nativeSelection.addRange(getNativeRange(range)),this.refresh())},selProto.setRanges=function(ranges){if(implementsControlRange&&ranges.length>1)createControlSelection(this,ranges);else{this.removeAllRanges();for(var i=0,len=ranges.length;len>i;++i)this.addRange(ranges[i])}}}else{if(!(util.isHostMethod(testSelection,"empty")&&util.isHostMethod(testRange,"select")&&implementsControlRange&&useDocumentSelection))return module.fail("No means of selecting a Range or TextRange was found"),!1;selProto.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var doc;if(this.anchorNode)doc=dom.getDocument(this.anchorNode);else if(this.docSelection.type==CONTROL){var controlRange=this.docSelection.createRange();controlRange.length&&(doc=dom.getDocument(controlRange.item(0)).body.createTextRange())}if(doc){var textRange=doc.body.createTextRange();textRange.select(),this.docSelection.empty()}}}catch(ex){}updateEmptySelection(this)},selProto.addRange=function(range){this.docSelection.type==CONTROL?addRangeToControlSelection(this,range):(WrappedRange.rangeToTextRange(range).select(),this._ranges[0]=range,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,updateAnchorAndFocusFromRange(this,range,!1))},selProto.setRanges=function(ranges){this.removeAllRanges();var rangeCount=ranges.length;rangeCount>1?createControlSelection(this,ranges):rangeCount&&this.addRange(ranges[0])}}selProto.getRangeAt=function(index){if(0>index||index>=this.rangeCount)throw new DOMException("INDEX_SIZE_ERR");return this._ranges[index]};var refreshSelection;if(useDocumentSelection)refreshSelection=function(sel){var range;api.isSelectionValid(sel.win)?range=sel.docSelection.createRange():(range=dom.getBody(sel.win.document).createTextRange(),range.collapse(!0)),sel.docSelection.type==CONTROL?updateControlSelection(sel):isTextRange(range)?updateFromTextRange(sel,range):updateEmptySelection(sel)};else if(util.isHostMethod(testSelection,"getRangeAt")&&"number"==typeof testSelection.rangeCount)refreshSelection=function(sel){if(implementsControlRange&&implementsDocSelection&&sel.docSelection.type==CONTROL)updateControlSelection(sel);else if(sel._ranges.length=sel.rangeCount=sel.nativeSelection.rangeCount,sel.rangeCount){for(var i=0,len=sel.rangeCount;len>i;++i)sel._ranges[i]=new api.WrappedRange(sel.nativeSelection.getRangeAt(i));updateAnchorAndFocusFromRange(sel,sel._ranges[sel.rangeCount-1],selectionIsBackwards(sel.nativeSelection)),sel.isCollapsed=selectionIsCollapsed(sel)}else updateEmptySelection(sel)};else{if(!selectionHasAnchorAndFocus||typeof testSelection.isCollapsed!=BOOLEAN||typeof testRange.collapsed!=BOOLEAN||!api.features.implementsDomRange)return module.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;refreshSelection=function(sel){var range,nativeSel=sel.nativeSelection;nativeSel.anchorNode?(range=getSelectionRangeAt(nativeSel,0),sel._ranges=[range],sel.rangeCount=1,updateAnchorAndFocusFromNativeSelection(sel),sel.isCollapsed=selectionIsCollapsed(sel)):updateEmptySelection(sel)}}selProto.refresh=function(checkForChanges){var oldRanges=checkForChanges?this._ranges.slice(0):null;if(refreshSelection(this),checkForChanges){var i=oldRanges.length;if(i!=this._ranges.length)return!1;for(;i--;)if(!DomRange.rangesEqual(oldRanges[i],this._ranges[i]))return!1;return!0}};var removeRangeManually=function(sel,range){var ranges=sel.getAllRanges(),removed=!1;sel.removeAllRanges();for(var i=0,len=ranges.length;len>i;++i)removed||range!==ranges[i]?sel.addRange(ranges[i]):removed=!0;sel.rangeCount||updateEmptySelection(sel)};selProto.removeRange=implementsControlRange?function(range){if(this.docSelection.type==CONTROL){for(var el,controlRange=this.docSelection.createRange(),rangeElement=getSingleElementFromRange(range),doc=dom.getDocument(controlRange.item(0)),newControlRange=dom.getBody(doc).createControlRange(),removed=!1,i=0,len=controlRange.length;len>i;++i)el=controlRange.item(i),el!==rangeElement||removed?newControlRange.add(controlRange.item(i)):removed=!0;newControlRange.select(),updateControlSelection(this)}else removeRangeManually(this,range)}:function(range){removeRangeManually(this,range)};var selectionIsBackwards;!useDocumentSelection&&selectionHasAnchorAndFocus&&api.features.implementsDomRange?(selectionIsBackwards=function(sel){var backwards=!1;return sel.anchorNode&&(backwards=1==dom.comparePoints(sel.anchorNode,sel.anchorOffset,sel.focusNode,sel.focusOffset)),backwards},selProto.isBackwards=function(){return selectionIsBackwards(this)}):selectionIsBackwards=selProto.isBackwards=function(){return!1},selProto.toString=function(){for(var rangeTexts=[],i=0,len=this.rangeCount;len>i;++i)rangeTexts[i]=""+this._ranges[i];return rangeTexts.join("")},selProto.collapse=function(node,offset){assertNodeInSameDocument(this,node);var range=api.createRange(dom.getDocument(node));range.collapseToPoint(node,offset),this.removeAllRanges(),this.addRange(range),this.isCollapsed=!0},selProto.collapseToStart=function(){if(!this.rangeCount)throw new DOMException("INVALID_STATE_ERR");var range=this._ranges[0];this.collapse(range.startContainer,range.startOffset)},selProto.collapseToEnd=function(){if(!this.rangeCount)throw new DOMException("INVALID_STATE_ERR");var range=this._ranges[this.rangeCount-1];this.collapse(range.endContainer,range.endOffset)},selProto.selectAllChildren=function(node){assertNodeInSameDocument(this,node);var range=api.createRange(dom.getDocument(node));range.selectNodeContents(node),this.removeAllRanges(),this.addRange(range)},selProto.deleteFromDocument=function(){if(implementsControlRange&&implementsDocSelection&&this.docSelection.type==CONTROL){for(var element,controlRange=this.docSelection.createRange();controlRange.length;)element=controlRange.item(0),controlRange.remove(element),element.parentNode.removeChild(element);this.refresh()}else if(this.rangeCount){var ranges=this.getAllRanges();this.removeAllRanges();for(var i=0,len=ranges.length;len>i;++i)ranges[i].deleteContents();this.addRange(ranges[len-1])}},selProto.getAllRanges=function(){return this._ranges.slice(0)},selProto.setSingleRange=function(range){this.setRanges([range])},selProto.containsNode=function(node,allowPartial){for(var i=0,len=this._ranges.length;len>i;++i)if(this._ranges[i].containsNode(node,allowPartial))return!0;return!1},selProto.toHtml=function(){var html="";if(this.rangeCount){for(var container=DomRange.getRangeDocument(this._ranges[0]).createElement("div"),i=0,len=this._ranges.length;len>i;++i)container.appendChild(this._ranges[i].cloneContents());html=container.innerHTML}return html},selProto.getName=function(){return"WrappedSelection"},selProto.inspect=function(){return inspect(this)},selProto.detach=function(){this.win[windowPropertyName]=null,this.win=this.anchorNode=this.focusNode=null},WrappedSelection.inspect=inspect,api.Selection=WrappedSelection,api.selectionPrototype=selProto,api.addCreateMissingNativeApiListener(function(win){"undefined"==typeof win.getSelection&&(win.getSelection=function(){return api.getSelection(this)}),win=null})});/*
	Base.js, version 1.1a
	Copyright 2006-2010, Dean Edwards
	License: http://www.opensource.org/licenses/mit-license.php
*/
var Base=function(){};Base.extend=function(_instance,_static){var extend=Base.prototype.extend;Base._prototyping=!0;var proto=new this;extend.call(proto,_instance),proto.base=function(){},delete Base._prototyping;var constructor=proto.constructor,klass=proto.constructor=function(){if(!Base._prototyping)if(this._constructing||this.constructor==klass)this._constructing=!0,constructor.apply(this,arguments),delete this._constructing;else if(null!=arguments[0])return(arguments[0].extend||extend).call(arguments[0],proto)};return klass.ancestor=this,klass.extend=this.extend,klass.forEach=this.forEach,klass.implement=this.implement,klass.prototype=proto,klass.toString=this.toString,klass.valueOf=function(type){return"object"==type?klass:constructor.valueOf()},extend.call(klass,_static),"function"==typeof klass.init&&klass.init(),klass},Base.prototype={extend:function(source,value){if(arguments.length>1){var ancestor=this[source];if(ancestor&&"function"==typeof value&&(!ancestor.valueOf||ancestor.valueOf()!=value.valueOf())&&/\bbase\b/.test(value)){var method=value.valueOf();value=function(){var previous=this.base||Base.prototype.base;this.base=ancestor;var returnValue=method.apply(this,arguments);return this.base=previous,returnValue},value.valueOf=function(type){return"object"==type?value:method},value.toString=Base.toString}this[source]=value}else if(source){var extend=Base.prototype.extend;Base._prototyping||"function"==typeof this||(extend=this.extend||extend);for(var proto={toSource:null},hidden=["constructor","toString","valueOf"],i=Base._prototyping?0:1;key=hidden[i++];)source[key]!=proto[key]&&extend.call(this,key,source[key]);for(var key in source)proto[key]||extend.call(this,key,source[key])}return this}},Base=Base.extend({constructor:function(){this.extend(arguments[0])}},{ancestor:Object,version:"1.1",forEach:function(object,block,context){for(var key in object)void 0===this.prototype[key]&&block.call(context,object[key],key,object)},implement:function(){for(var i=0;i<arguments.length;i++)"function"==typeof arguments[i]?arguments[i](this.prototype):this.prototype.extend(arguments[i]);return this},toString:function(){return String(this.valueOf())}}),wysihtml5.browser=function(){function iosVersion(userAgent){return(/ipad|iphone|ipod/.test(userAgent)&&userAgent.match(/ os (\d+).+? like mac os x/)||[,0])[1]}var userAgent=navigator.userAgent,testElement=document.createElement("div"),isIE=-1!==userAgent.indexOf("MSIE")&&-1===userAgent.indexOf("Opera"),isGecko=-1!==userAgent.indexOf("Gecko")&&-1===userAgent.indexOf("KHTML"),isWebKit=-1!==userAgent.indexOf("AppleWebKit/"),isChrome=-1!==userAgent.indexOf("Chrome/"),isOpera=-1!==userAgent.indexOf("Opera/");return{USER_AGENT:userAgent,supported:function(){var userAgent=this.USER_AGENT.toLowerCase(),hasContentEditableSupport="contentEditable"in testElement,hasEditingApiSupport=document.execCommand&&document.queryCommandSupported&&document.queryCommandState,hasQuerySelectorSupport=document.querySelector&&document.querySelectorAll,isIncompatibleMobileBrowser=this.isIos()&&iosVersion(userAgent)<5||-1!==userAgent.indexOf("opera mobi")||-1!==userAgent.indexOf("hpwos/");return hasContentEditableSupport&&hasEditingApiSupport&&hasQuerySelectorSupport&&!isIncompatibleMobileBrowser},isTouchDevice:function(){return this.supportsEvent("touchmove")},isIos:function(){var userAgent=this.USER_AGENT.toLowerCase();return-1!==userAgent.indexOf("webkit")&&-1!==userAgent.indexOf("mobile")},supportsSandboxedIframes:function(){return isIE},throwsMixedContentWarningWhenIframeSrcIsEmpty:function(){return!("querySelector"in document)},displaysCaretInEmptyContentEditableCorrectly:function(){return!isGecko},hasCurrentStyleProperty:function(){return"currentStyle"in testElement},insertsLineBreaksOnReturn:function(){return isGecko},supportsPlaceholderAttributeOn:function(element){return"placeholder"in element},supportsEvent:function(eventName){return"on"+eventName in testElement||function(){return testElement.setAttribute("on"+eventName,"return;"),"function"==typeof testElement["on"+eventName]}()},supportsEventsInIframeCorrectly:function(){return!isOpera},firesOnDropOnlyWhenOnDragOverIsCancelled:function(){return isWebKit||isGecko},supportsDataTransfer:function(){try{return isWebKit&&(window.Clipboard||window.DataTransfer).prototype.getData}catch(e){return!1}},supportsHTML5Tags:function(context){var element=context.createElement("div"),html5="<article>foo</article>";return element.innerHTML=html5,element.innerHTML.toLowerCase()===html5},supportsCommand:function(){var buggyCommands={formatBlock:isIE,insertUnorderedList:isIE||isOpera||isWebKit,insertOrderedList:isIE||isOpera||isWebKit},supported={insertHTML:isGecko};return function(doc,command){var isBuggy=buggyCommands[command];if(!isBuggy){try{return doc.queryCommandSupported(command)}catch(e1){}try{return doc.queryCommandEnabled(command)}catch(e2){return!!supported[command]}}return!1}}(),doesAutoLinkingInContentEditable:function(){return isIE},canDisableAutoLinking:function(){return this.supportsCommand(document,"AutoUrlDetect")},clearsContentEditableCorrectly:function(){return isGecko||isOpera||isWebKit},supportsGetAttributeCorrectly:function(){var td=document.createElement("td");return"1"!=td.getAttribute("rowspan")},canSelectImagesInContentEditable:function(){return isGecko||isIE||isOpera},clearsListsInContentEditableCorrectly:function(){return isGecko||isIE||isWebKit},autoScrollsToCaret:function(){return!isWebKit},autoClosesUnclosedTags:function(){var returnValue,innerHTML,clonedTestElement=testElement.cloneNode(!1);return clonedTestElement.innerHTML="<p><div></div>",innerHTML=clonedTestElement.innerHTML.toLowerCase(),returnValue="<p></p><div></div>"===innerHTML||"<p><div></div></p>"===innerHTML,this.autoClosesUnclosedTags=function(){return returnValue},returnValue},supportsNativeGetElementsByClassName:function(){return-1!==String(document.getElementsByClassName).indexOf("[native code]")},supportsSelectionModify:function(){return"getSelection"in window&&"modify"in window.getSelection()},supportsClassList:function(){return"classList"in testElement},needsSpaceAfterLineBreak:function(){return isOpera},supportsSpeechApiOn:function(input){var chromeVersion=userAgent.match(/Chrome\/(\d+)/)||[,0];return chromeVersion[1]>=11&&("onwebkitspeechchange"in input||"speech"in input)},crashesWhenDefineProperty:function(property){return isIE&&("XMLHttpRequest"===property||"XDomainRequest"===property)},doesAsyncFocus:function(){return isIE},hasProblemsSettingCaretAfterImg:function(){return isIE},hasUndoInContextMenu:function(){return isGecko||isChrome||isOpera}}}(),wysihtml5.lang.array=function(arr){return{contains:function(needle){if(arr.indexOf)return-1!==arr.indexOf(needle);for(var i=0,length=arr.length;length>i;i++)if(arr[i]===needle)return!0;return!1},without:function(arrayToSubstract){arrayToSubstract=wysihtml5.lang.array(arrayToSubstract);for(var newArr=[],i=0,length=arr.length;length>i;i++)arrayToSubstract.contains(arr[i])||newArr.push(arr[i]);return newArr},get:function(){for(var i=0,length=arr.length,newArray=[];length>i;i++)newArray.push(arr[i]);return newArray}}},wysihtml5.lang.Dispatcher=Base.extend({observe:function(eventName,handler){return this.events=this.events||{},this.events[eventName]=this.events[eventName]||[],this.events[eventName].push(handler),this},on:function(){return this.observe.apply(this,wysihtml5.lang.array(arguments).get())},fire:function(eventName,payload){this.events=this.events||{};for(var handlers=this.events[eventName]||[],i=0;i<handlers.length;i++)handlers[i].call(this,payload);return this},stopObserving:function(eventName,handler){this.events=this.events||{};var handlers,newHandlers,i=0;if(eventName){for(handlers=this.events[eventName]||[],newHandlers=[];i<handlers.length;i++)handlers[i]!==handler&&handler&&newHandlers.push(handlers[i]);this.events[eventName]=newHandlers}else this.events={};return this}}),wysihtml5.lang.object=function(obj){return{merge:function(otherObj){for(var i in otherObj)obj[i]=otherObj[i];return this},get:function(){return obj},clone:function(){var i,newObj={};for(i in obj)newObj[i]=obj[i];return newObj},isArray:function(){return"[object Array]"===Object.prototype.toString.call(obj)}}},function(){var WHITE_SPACE_START=/^\s+/,WHITE_SPACE_END=/\s+$/;wysihtml5.lang.string=function(str){return str=String(str),{trim:function(){return str.replace(WHITE_SPACE_START,"").replace(WHITE_SPACE_END,"")},interpolate:function(vars){for(var i in vars)str=this.replace("#{"+i+"}").by(vars[i]);return str},replace:function(search){return{by:function(replace){return str.split(search).join(replace)}}}}}}(),function(wysihtml5){function autoLink(element){return _hasParentThatShouldBeIgnored(element)?element:(element===element.ownerDocument.documentElement&&(element=element.ownerDocument.body),_parseNode(element))}function _convertUrlsToLinks(str){return str.replace(URL_REG_EXP,function(match,url){var punctuation=(url.match(TRAILING_CHAR_REG_EXP)||[])[1]||"",opening=BRACKETS[punctuation];url=url.replace(TRAILING_CHAR_REG_EXP,""),url.split(opening).length>url.split(punctuation).length&&(url+=punctuation,punctuation="");var realUrl=url,displayUrl=url;return url.length>MAX_DISPLAY_LENGTH&&(displayUrl=displayUrl.substr(0,MAX_DISPLAY_LENGTH)+"..."),"www."===realUrl.substr(0,4)&&(realUrl="http://"+realUrl),'<a href="'+realUrl+'">'+displayUrl+"</a>"+punctuation})}function _getTempElement(context){var tempElement=context._wysihtml5_tempElement;return tempElement||(tempElement=context._wysihtml5_tempElement=context.createElement("div")),tempElement}function _wrapMatchesInNode(textNode){var parentNode=textNode.parentNode,tempElement=_getTempElement(parentNode.ownerDocument);for(tempElement.innerHTML="<span></span>"+_convertUrlsToLinks(textNode.data),tempElement.removeChild(tempElement.firstChild);tempElement.firstChild;)parentNode.insertBefore(tempElement.firstChild,textNode);parentNode.removeChild(textNode)}function _hasParentThatShouldBeIgnored(node){for(var nodeName;node.parentNode;){if(node=node.parentNode,nodeName=node.nodeName,IGNORE_URLS_IN.contains(nodeName))return!0;if("body"===nodeName)return!1}return!1}function _parseNode(element){if(!IGNORE_URLS_IN.contains(element.nodeName)){if(element.nodeType===wysihtml5.TEXT_NODE&&element.data.match(URL_REG_EXP))return _wrapMatchesInNode(element),void 0;for(var childNodes=wysihtml5.lang.array(element.childNodes).get(),childNodesLength=childNodes.length,i=0;childNodesLength>i;i++)_parseNode(childNodes[i]);return element}}var IGNORE_URLS_IN=wysihtml5.lang.array(["CODE","PRE","A","SCRIPT","HEAD","TITLE","STYLE"]),URL_REG_EXP=/((https?:\/\/|www\.)[^\s<]{3,})/gi,TRAILING_CHAR_REG_EXP=/([^\w\/\-](,?))$/i,MAX_DISPLAY_LENGTH=100,BRACKETS={")":"(","]":"[","}":"{"};wysihtml5.dom.autoLink=autoLink,wysihtml5.dom.autoLink.URL_REG_EXP=URL_REG_EXP}(wysihtml5),function(wysihtml5){var supportsClassList=wysihtml5.browser.supportsClassList(),api=wysihtml5.dom;api.addClass=function(element,className){return supportsClassList?element.classList.add(className):(api.hasClass(element,className)||(element.className+=" "+className),void 0)},api.removeClass=function(element,className){return supportsClassList?element.classList.remove(className):(element.className=element.className.replace(new RegExp("(^|\\s+)"+className+"(\\s+|$)")," "),void 0)},api.hasClass=function(element,className){if(supportsClassList)return element.classList.contains(className);var elementClassName=element.className;return elementClassName.length>0&&(elementClassName==className||new RegExp("(^|\\s)"+className+"(\\s|$)").test(elementClassName))}}(wysihtml5),wysihtml5.dom.contains=function(){var documentElement=document.documentElement;return documentElement.contains?function(container,element){return element.nodeType!==wysihtml5.ELEMENT_NODE&&(element=element.parentNode),container!==element&&container.contains(element)}:documentElement.compareDocumentPosition?function(container,element){return!!(16&container.compareDocumentPosition(element))}:void 0}(),wysihtml5.dom.convertToList=function(){function _createListItem(doc,list){var listItem=doc.createElement("li");return list.appendChild(listItem),listItem}function _createList(doc,type){return doc.createElement(type)}function convertToList(element,listType){if("UL"===element.nodeName||"OL"===element.nodeName||"MENU"===element.nodeName)return element;var childNodes,childNodesLength,childNode,lineBreak,parentNode,isBlockElement,isLineBreak,currentListItem,i,doc=element.ownerDocument,list=_createList(doc,listType),lineBreaks=element.querySelectorAll("br"),lineBreaksLength=lineBreaks.length;for(i=0;lineBreaksLength>i;i++)for(lineBreak=lineBreaks[i];(parentNode=lineBreak.parentNode)&&parentNode!==element&&parentNode.lastChild===lineBreak;){if("block"===wysihtml5.dom.getStyle("display").from(parentNode)){parentNode.removeChild(lineBreak);break}wysihtml5.dom.insert(lineBreak).after(lineBreak.parentNode)}for(childNodes=wysihtml5.lang.array(element.childNodes).get(),childNodesLength=childNodes.length,i=0;childNodesLength>i;i++)currentListItem=currentListItem||_createListItem(doc,list),childNode=childNodes[i],isBlockElement="block"===wysihtml5.dom.getStyle("display").from(childNode),isLineBreak="BR"===childNode.nodeName,isBlockElement?(currentListItem=currentListItem.firstChild?_createListItem(doc,list):currentListItem,currentListItem.appendChild(childNode),currentListItem=null):isLineBreak?currentListItem=currentListItem.firstChild?null:currentListItem:currentListItem.appendChild(childNode);return element.parentNode.replaceChild(list,element),list}return convertToList}(),wysihtml5.dom.copyAttributes=function(attributesToCopy){return{from:function(elementToCopyFrom){return{to:function(elementToCopyTo){for(var attribute,i=0,length=attributesToCopy.length;length>i;i++)attribute=attributesToCopy[i],"undefined"!=typeof elementToCopyFrom[attribute]&&""!==elementToCopyFrom[attribute]&&(elementToCopyTo[attribute]=elementToCopyFrom[attribute]);return{andTo:arguments.callee}}}}}},function(dom){var BOX_SIZING_PROPERTIES=["-webkit-box-sizing","-moz-box-sizing","-ms-box-sizing","box-sizing"],shouldIgnoreBoxSizingBorderBox=function(element){return hasBoxSizingBorderBox(element)?parseInt(dom.getStyle("width").from(element),10)<element.offsetWidth:!1},hasBoxSizingBorderBox=function(element){for(var i=0,length=BOX_SIZING_PROPERTIES.length;length>i;i++)if("border-box"===dom.getStyle(BOX_SIZING_PROPERTIES[i]).from(element))return BOX_SIZING_PROPERTIES[i]};dom.copyStyles=function(stylesToCopy){return{from:function(element){shouldIgnoreBoxSizingBorderBox(element)&&(stylesToCopy=wysihtml5.lang.array(stylesToCopy).without(BOX_SIZING_PROPERTIES));for(var property,cssText="",length=stylesToCopy.length,i=0;length>i;i++)property=stylesToCopy[i],cssText+=property+":"+dom.getStyle(property).from(element)+";";return{to:function(element){return dom.setStyles(cssText).on(element),{andTo:arguments.callee}}}}}}}(wysihtml5.dom),function(wysihtml5){wysihtml5.dom.delegate=function(container,selector,eventName,handler){return wysihtml5.dom.observe(container,eventName,function(event){for(var target=event.target,match=wysihtml5.lang.array(container.querySelectorAll(selector));target&&target!==container;){if(match.contains(target)){handler.call(target,event);break}target=target.parentNode}})}}(wysihtml5),wysihtml5.dom.getAsDom=function(){var _innerHTMLShiv=function(html,context){var tempElement=context.createElement("div");tempElement.style.display="none",context.body.appendChild(tempElement);try{tempElement.innerHTML=html}catch(e){}return context.body.removeChild(tempElement),tempElement},_ensureHTML5Compatibility=function(context){if(!context._wysihtml5_supportsHTML5Tags){for(var i=0,length=HTML5_ELEMENTS.length;length>i;i++)context.createElement(HTML5_ELEMENTS[i]);context._wysihtml5_supportsHTML5Tags=!0}},HTML5_ELEMENTS=["abbr","article","aside","audio","bdi","canvas","command","datalist","details","figcaption","figure","footer","header","hgroup","keygen","mark","meter","nav","output","progress","rp","rt","ruby","svg","section","source","summary","time","track","video","wbr"];return function(html,context){context=context||document;var tempElement;return"object"==typeof html&&html.nodeType?(tempElement=context.createElement("div"),tempElement.appendChild(html)):wysihtml5.browser.supportsHTML5Tags(context)?(tempElement=context.createElement("div"),tempElement.innerHTML=html):(_ensureHTML5Compatibility(context),tempElement=_innerHTMLShiv(html,context)),tempElement}}(),wysihtml5.dom.getParentElement=function(){function _isSameNodeName(nodeName,desiredNodeNames){return desiredNodeNames&&desiredNodeNames.length?"string"==typeof desiredNodeNames?nodeName===desiredNodeNames:wysihtml5.lang.array(desiredNodeNames).contains(nodeName):!0}function _isElement(node){return node.nodeType===wysihtml5.ELEMENT_NODE}function _hasClassName(element,className,classRegExp){var classNames=(element.className||"").match(classRegExp)||[];return className?classNames[classNames.length-1]===className:!!classNames.length}function _getParentElementWithNodeName(node,nodeName,levels){for(;levels--&&node&&"BODY"!==node.nodeName;){if(_isSameNodeName(node.nodeName,nodeName))return node;node=node.parentNode}return null}function _getParentElementWithNodeNameAndClassName(node,nodeName,className,classRegExp,levels){for(;levels--&&node&&"BODY"!==node.nodeName;){if(_isElement(node)&&_isSameNodeName(node.nodeName,nodeName)&&_hasClassName(node,className,classRegExp))return node;node=node.parentNode}return null}return function(node,matchingSet,levels){return levels=levels||50,matchingSet.className||matchingSet.classRegExp?_getParentElementWithNodeNameAndClassName(node,matchingSet.nodeName,matchingSet.className,matchingSet.classRegExp,levels):_getParentElementWithNodeName(node,matchingSet.nodeName,levels)}}(),wysihtml5.dom.getStyle=function(){function camelize(str){return str.replace(REG_EXP_CAMELIZE,function(match){return match.charAt(1).toUpperCase()})}var stylePropertyMapping={"float":"styleFloat"in document.createElement("div").style?"styleFloat":"cssFloat"},REG_EXP_CAMELIZE=/\-[a-z]/g;return function(property){return{from:function(element){if(element.nodeType===wysihtml5.ELEMENT_NODE){var doc=element.ownerDocument,camelizedProperty=stylePropertyMapping[property]||camelize(property),style=element.style,currentStyle=element.currentStyle,styleValue=style[camelizedProperty];if(styleValue)return styleValue;if(currentStyle)try{return currentStyle[camelizedProperty]}catch(e){}var originalOverflow,returnValue,win=doc.defaultView||doc.parentWindow,needsOverflowReset=("height"===property||"width"===property)&&"TEXTAREA"===element.nodeName;return win.getComputedStyle?(needsOverflowReset&&(originalOverflow=style.overflow,style.overflow="hidden"),returnValue=win.getComputedStyle(element,null).getPropertyValue(property),needsOverflowReset&&(style.overflow=originalOverflow||""),returnValue):void 0}}}}}(),wysihtml5.dom.hasElementWithTagName=function(){function _getDocumentIdentifier(doc){return doc._wysihtml5_identifier||(doc._wysihtml5_identifier=DOCUMENT_IDENTIFIER++)}var LIVE_CACHE={},DOCUMENT_IDENTIFIER=1;return function(doc,tagName){var key=_getDocumentIdentifier(doc)+":"+tagName,cacheEntry=LIVE_CACHE[key];return cacheEntry||(cacheEntry=LIVE_CACHE[key]=doc.getElementsByTagName(tagName)),cacheEntry.length>0}}(),function(wysihtml5){function _getDocumentIdentifier(doc){return doc._wysihtml5_identifier||(doc._wysihtml5_identifier=DOCUMENT_IDENTIFIER++)}var LIVE_CACHE={},DOCUMENT_IDENTIFIER=1;wysihtml5.dom.hasElementWithClassName=function(doc,className){if(!wysihtml5.browser.supportsNativeGetElementsByClassName())return!!doc.querySelector("."+className);var key=_getDocumentIdentifier(doc)+":"+className,cacheEntry=LIVE_CACHE[key];return cacheEntry||(cacheEntry=LIVE_CACHE[key]=doc.getElementsByClassName(className)),cacheEntry.length>0}}(wysihtml5),wysihtml5.dom.insert=function(elementToInsert){return{after:function(element){element.parentNode.insertBefore(elementToInsert,element.nextSibling)},before:function(element){element.parentNode.insertBefore(elementToInsert,element)},into:function(element){element.appendChild(elementToInsert)}}},wysihtml5.dom.insertCSS=function(rules){return rules=rules.join("\n"),{into:function(doc){var head=doc.head||doc.getElementsByTagName("head")[0],styleElement=doc.createElement("style");styleElement.type="text/css",styleElement.styleSheet?styleElement.styleSheet.cssText=rules:styleElement.appendChild(doc.createTextNode(rules)),head&&head.appendChild(styleElement)}}},wysihtml5.dom.observe=function(element,eventNames,handler){eventNames="string"==typeof eventNames?[eventNames]:eventNames;for(var handlerWrapper,eventName,i=0,length=eventNames.length;length>i;i++)eventName=eventNames[i],element.addEventListener?element.addEventListener(eventName,handler,!1):(handlerWrapper=function(event){"target"in event||(event.target=event.srcElement),event.preventDefault=event.preventDefault||function(){this.returnValue=!1},event.stopPropagation=event.stopPropagation||function(){this.cancelBubble=!0},handler.call(element,event)},element.attachEvent("on"+eventName,handlerWrapper));return{stop:function(){for(var eventName,i=0,length=eventNames.length;length>i;i++)eventName=eventNames[i],element.removeEventListener?element.removeEventListener(eventName,handler,!1):element.detachEvent("on"+eventName,handlerWrapper)}}},wysihtml5.dom.parse=function(){function parse(elementOrHtml,rules,context,cleanUp){wysihtml5.lang.object(currentRules).merge(defaultRules).merge(rules).get(),context=context||elementOrHtml.ownerDocument||document;var element,newNode,firstChild,fragment=context.createDocumentFragment(),isString="string"==typeof elementOrHtml;for(element=isString?wysihtml5.dom.getAsDom(elementOrHtml,context):elementOrHtml;element.firstChild;)firstChild=element.firstChild,element.removeChild(firstChild),newNode=_convert(firstChild,cleanUp),newNode&&fragment.appendChild(newNode);return element.innerHTML="",element.appendChild(fragment),isString?wysihtml5.quirks.getCorrectInnerHTML(element):element}function _convert(oldNode,cleanUp){var newNode,oldNodeType=oldNode.nodeType,oldChilds=oldNode.childNodes,oldChildsLength=oldChilds.length,method=NODE_TYPE_MAPPING[oldNodeType],i=0;if(newNode=method&&method(oldNode),!newNode)return null;for(i=0;oldChildsLength>i;i++)newChild=_convert(oldChilds[i],cleanUp),newChild&&newNode.appendChild(newChild);return cleanUp&&newNode.childNodes.length<=1&&newNode.nodeName.toLowerCase()===DEFAULT_NODE_NAME&&!newNode.attributes.length?newNode.firstChild:newNode}function _handleElement(oldNode){var rule,newNode,tagRules=currentRules.tags,nodeName=oldNode.nodeName.toLowerCase(),scopeName=oldNode.scopeName;if(oldNode._wysihtml5)return null;if(oldNode._wysihtml5=1,"wysihtml5-temp"===oldNode.className)return null;if(scopeName&&"HTML"!=scopeName&&(nodeName=scopeName+":"+nodeName),"outerHTML"in oldNode&&(wysihtml5.browser.autoClosesUnclosedTags()||"P"!==oldNode.nodeName||"</p>"===oldNode.outerHTML.slice(-4).toLowerCase()||(nodeName="div")),nodeName in tagRules){if(rule=tagRules[nodeName],!rule||rule.remove)return null;rule="string"==typeof rule?{rename_tag:rule}:rule}else{if(!oldNode.firstChild)return null;rule={rename_tag:DEFAULT_NODE_NAME}}return newNode=oldNode.ownerDocument.createElement(rule.rename_tag||nodeName),_handleAttributes(oldNode,newNode,rule),oldNode=null,newNode}function _handleAttributes(oldNode,newNode,rule){var classesLength,newClassesLength,currentClass,newClass,attributeName,newAttributeValue,method,attributes={},setClass=rule.set_class,addClass=rule.add_class,setAttributes=rule.set_attributes,checkAttributes=rule.check_attributes,allowedClasses=currentRules.classes,i=0,classes=[],newClasses=[],newUniqueClasses=[],oldClasses=[];if(setAttributes&&(attributes=wysihtml5.lang.object(setAttributes).clone()),checkAttributes)for(attributeName in checkAttributes)method=attributeCheckMethods[checkAttributes[attributeName]],method&&(newAttributeValue=method(_getAttribute(oldNode,attributeName)),"string"==typeof newAttributeValue&&(attributes[attributeName]=newAttributeValue));if(setClass&&classes.push(setClass),addClass)for(attributeName in addClass)method=addClassMethods[addClass[attributeName]],method&&(newClass=method(_getAttribute(oldNode,attributeName)),"string"==typeof newClass&&classes.push(newClass));for(allowedClasses["_wysihtml5-temp-placeholder"]=1,oldClasses=oldNode.getAttribute("class"),oldClasses&&(classes=classes.concat(oldClasses.split(WHITE_SPACE_REG_EXP))),classesLength=classes.length;classesLength>i;i++)currentClass=classes[i],allowedClasses[currentClass]&&newClasses.push(currentClass);for(newClassesLength=newClasses.length;newClassesLength--;)currentClass=newClasses[newClassesLength],wysihtml5.lang.array(newUniqueClasses).contains(currentClass)||newUniqueClasses.unshift(currentClass);newUniqueClasses.length&&(attributes["class"]=newUniqueClasses.join(" "));for(attributeName in attributes)try{newNode.setAttribute(attributeName,attributes[attributeName])}catch(e){}attributes.src&&("undefined"!=typeof attributes.width&&newNode.setAttribute("width",attributes.width),"undefined"!=typeof attributes.height&&newNode.setAttribute("height",attributes.height))}function _getAttribute(node,attributeName){attributeName=attributeName.toLowerCase();var nodeName=node.nodeName;if("IMG"==nodeName&&"src"==attributeName&&_isLoadedImage(node)===!0)return node.src;if(HAS_GET_ATTRIBUTE_BUG&&"outerHTML"in node){var outerHTML=node.outerHTML.toLowerCase(),hasAttribute=-1!=outerHTML.indexOf(" "+attributeName+"=");return hasAttribute?node.getAttribute(attributeName):null}return node.getAttribute(attributeName)}function _isLoadedImage(node){try{return node.complete&&!node.mozMatchesSelector(":-moz-broken")}catch(e){if(node.complete&&"complete"===node.readyState)return!0}}function _handleText(oldNode){return oldNode.ownerDocument.createTextNode(oldNode.data)}var NODE_TYPE_MAPPING={1:_handleElement,3:_handleText},DEFAULT_NODE_NAME="span",WHITE_SPACE_REG_EXP=/\s+/,defaultRules={tags:{},classes:{}},currentRules={},HAS_GET_ATTRIBUTE_BUG=!wysihtml5.browser.supportsGetAttributeCorrectly(),attributeCheckMethods={url:function(){var REG_EXP=/^https?:\/\//i;return function(attributeValue){return attributeValue&&attributeValue.match(REG_EXP)?attributeValue.replace(REG_EXP,function(match){return match.toLowerCase()}):null}}(),alt:function(){var REG_EXP=/[^ a-z0-9_\-]/gi;return function(attributeValue){return attributeValue?attributeValue.replace(REG_EXP,""):""}}(),numbers:function(){var REG_EXP=/\D/g;return function(attributeValue){return attributeValue=(attributeValue||"").replace(REG_EXP,""),attributeValue||null}}()},addClassMethods={align_img:function(){var mapping={left:"wysiwyg-float-left",right:"wysiwyg-float-right"};return function(attributeValue){return mapping[String(attributeValue).toLowerCase()]}}(),align_text:function(){var mapping={left:"wysiwyg-text-align-left",right:"wysiwyg-text-align-right",center:"wysiwyg-text-align-center",justify:"wysiwyg-text-align-justify"};return function(attributeValue){return mapping[String(attributeValue).toLowerCase()]}}(),clear_br:function(){var mapping={left:"wysiwyg-clear-left",right:"wysiwyg-clear-right",both:"wysiwyg-clear-both",all:"wysiwyg-clear-both"};return function(attributeValue){return mapping[String(attributeValue).toLowerCase()]}}(),size_font:function(){var mapping={1:"wysiwyg-font-size-xx-small",2:"wysiwyg-font-size-small",3:"wysiwyg-font-size-medium",4:"wysiwyg-font-size-large",5:"wysiwyg-font-size-x-large",6:"wysiwyg-font-size-xx-large",7:"wysiwyg-font-size-xx-large","-":"wysiwyg-font-size-smaller","+":"wysiwyg-font-size-larger"};return function(attributeValue){return mapping[String(attributeValue).charAt(0)]}}()};return parse}(),wysihtml5.dom.removeEmptyTextNodes=function(node){for(var childNode,childNodes=wysihtml5.lang.array(node.childNodes).get(),childNodesLength=childNodes.length,i=0;childNodesLength>i;i++)childNode=childNodes[i],childNode.nodeType===wysihtml5.TEXT_NODE&&""===childNode.data&&childNode.parentNode.removeChild(childNode)},wysihtml5.dom.renameElement=function(element,newNodeName){for(var firstChild,newElement=element.ownerDocument.createElement(newNodeName);firstChild=element.firstChild;)newElement.appendChild(firstChild);return wysihtml5.dom.copyAttributes(["align","className"]).from(element).to(newElement),element.parentNode.replaceChild(newElement,element),newElement},wysihtml5.dom.replaceWithChildNodes=function(node){if(node.parentNode){if(!node.firstChild)return node.parentNode.removeChild(node),void 0;for(var fragment=node.ownerDocument.createDocumentFragment();node.firstChild;)fragment.appendChild(node.firstChild);node.parentNode.replaceChild(fragment,node),node=fragment=null}},function(dom){function _isBlockElement(node){return"block"===dom.getStyle("display").from(node)}function _isLineBreak(node){return"BR"===node.nodeName}function _appendLineBreak(element){var lineBreak=element.ownerDocument.createElement("br");element.appendChild(lineBreak)}function resolveList(list){if("MENU"===list.nodeName||"UL"===list.nodeName||"OL"===list.nodeName){var firstChild,lastChild,isLastChild,shouldAppendLineBreak,listItem,doc=list.ownerDocument,fragment=doc.createDocumentFragment(),previousSibling=list.previousElementSibling||list.previousSibling;for(previousSibling&&!_isBlockElement(previousSibling)&&_appendLineBreak(fragment);listItem=list.firstChild;){for(lastChild=listItem.lastChild;firstChild=listItem.firstChild;)isLastChild=firstChild===lastChild,shouldAppendLineBreak=isLastChild&&!_isBlockElement(firstChild)&&!_isLineBreak(firstChild),fragment.appendChild(firstChild),shouldAppendLineBreak&&_appendLineBreak(fragment);listItem.parentNode.removeChild(listItem)}list.parentNode.replaceChild(fragment,list)}}dom.resolveList=resolveList}(wysihtml5.dom),function(wysihtml5){var doc=document,windowProperties=["parent","top","opener","frameElement","frames","localStorage","globalStorage","sessionStorage","indexedDB"],windowProperties2=["open","close","openDialog","showModalDialog","alert","confirm","prompt","openDatabase","postMessage","XMLHttpRequest","XDomainRequest"],documentProperties=["referrer","write","open","close"];wysihtml5.dom.Sandbox=Base.extend({constructor:function(readyCallback,config){this.callback=readyCallback||wysihtml5.EMPTY_FUNCTION,this.config=wysihtml5.lang.object({}).merge(config).get(),this.iframe=this._createIframe()},insertInto:function(element){"string"==typeof element&&(element=doc.getElementById(element)),element.appendChild(this.iframe)},getIframe:function(){return this.iframe},getWindow:function(){this._readyError()},getDocument:function(){this._readyError()},destroy:function(){var iframe=this.getIframe();iframe.parentNode.removeChild(iframe)},_readyError:function(){throw new Error("wysihtml5.Sandbox: Sandbox iframe isn't loaded yet")},_createIframe:function(){var that=this,iframe=doc.createElement("iframe");return iframe.className="wysihtml5-sandbox",wysihtml5.dom.setAttributes({security:"restricted",allowtransparency:"true",frameborder:0,width:0,height:0,marginwidth:0,marginheight:0}).on(iframe),wysihtml5.browser.throwsMixedContentWarningWhenIframeSrcIsEmpty()&&(iframe.src="javascript:'<html></html>'"),iframe.onload=function(){iframe.onreadystatechange=iframe.onload=null,that._onLoadIframe(iframe)},iframe.onreadystatechange=function(){/loaded|complete/.test(iframe.readyState)&&(iframe.onreadystatechange=iframe.onload=null,that._onLoadIframe(iframe))},iframe},_onLoadIframe:function(iframe){if(wysihtml5.dom.contains(doc.documentElement,iframe)){var that=this,iframeWindow=iframe.contentWindow,iframeDocument=iframe.contentWindow.document,charset=doc.characterSet||doc.charset||"utf-8",sandboxHtml=this._getHtml({charset:charset,stylesheets:this.config.stylesheets});if(iframeDocument.open("text/html","replace"),iframeDocument.write(sandboxHtml),iframeDocument.close(),this.getWindow=function(){return iframe.contentWindow},this.getDocument=function(){return iframe.contentWindow.document},iframeWindow.onerror=function(errorMessage,fileName,lineNumber){throw new Error("wysihtml5.Sandbox: "+errorMessage,fileName,lineNumber)},!wysihtml5.browser.supportsSandboxedIframes()){var i,length;for(i=0,length=windowProperties.length;length>i;i++)this._unset(iframeWindow,windowProperties[i]);for(i=0,length=windowProperties2.length;length>i;i++)this._unset(iframeWindow,windowProperties2[i],wysihtml5.EMPTY_FUNCTION);for(i=0,length=documentProperties.length;length>i;i++)this._unset(iframeDocument,documentProperties[i]);this._unset(iframeDocument,"cookie","",!0)}this.loaded=!0,setTimeout(function(){that.callback(that)},0)}},_getHtml:function(templateVars){var length,stylesheets=templateVars.stylesheets,html="",i=0;
if(stylesheets="string"==typeof stylesheets?[stylesheets]:stylesheets)for(length=stylesheets.length;length>i;i++)html+='<link rel="stylesheet" href="'+stylesheets[i]+'">';return templateVars.stylesheets=html,wysihtml5.lang.string('<!DOCTYPE html><html><head><meta charset="#{charset}">#{stylesheets}</head><body></body></html>').interpolate(templateVars)},_unset:function(object,property,value,setter){try{object[property]=value}catch(e){}try{object.__defineGetter__(property,function(){return value})}catch(e){}if(setter)try{object.__defineSetter__(property,function(){})}catch(e){}if(!wysihtml5.browser.crashesWhenDefineProperty(property))try{var config={get:function(){return value}};setter&&(config.set=function(){}),Object.defineProperty(object,property,config)}catch(e){}}})}(wysihtml5),function(){var mapping={className:"class"};wysihtml5.dom.setAttributes=function(attributes){return{on:function(element){for(var i in attributes)element.setAttribute(mapping[i]||i,attributes[i])}}}}(),wysihtml5.dom.setStyles=function(styles){return{on:function(element){var style=element.style;if("string"==typeof styles)return style.cssText+=";"+styles,void 0;for(var i in styles)"float"===i?(style.cssFloat=styles[i],style.styleFloat=styles[i]):style[i]=styles[i]}}},function(dom){dom.simulatePlaceholder=function(editor,view,placeholderText){var CLASS_NAME="placeholder",unset=function(){view.hasPlaceholderSet()&&view.clear(),dom.removeClass(view.element,CLASS_NAME)},set=function(){view.isEmpty()&&(view.setValue(placeholderText),dom.addClass(view.element,CLASS_NAME))};editor.observe("set_placeholder",set).observe("unset_placeholder",unset).observe("focus:composer",unset).observe("paste:composer",unset).observe("blur:composer",set),set()}}(wysihtml5.dom),function(dom){var documentElement=document.documentElement;"textContent"in documentElement?(dom.setTextContent=function(element,text){element.textContent=text},dom.getTextContent=function(element){return element.textContent}):"innerText"in documentElement?(dom.setTextContent=function(element,text){element.innerText=text},dom.getTextContent=function(element){return element.innerText}):(dom.setTextContent=function(element,text){element.nodeValue=text},dom.getTextContent=function(element){return element.nodeValue})}(wysihtml5.dom),wysihtml5.quirks.cleanPastedHTML=function(){function cleanPastedHTML(elementOrHtml,rules,context){rules=rules||defaultRules,context=context||elementOrHtml.ownerDocument||document;var element,method,matches,matchesLength,i,isString="string"==typeof elementOrHtml,j=0;element=isString?wysihtml5.dom.getAsDom(elementOrHtml,context):elementOrHtml;for(i in rules)for(matches=element.querySelectorAll(i),method=rules[i],matchesLength=matches.length;matchesLength>j;j++)method(matches[j]);return matches=elementOrHtml=rules=null,isString?element.innerHTML:element}var defaultRules={"a u":wysihtml5.dom.replaceWithChildNodes};return cleanPastedHTML}(),function(wysihtml5){var dom=wysihtml5.dom;wysihtml5.quirks.ensureProperClearing=function(){var clearIfNecessary=function(){var element=this;setTimeout(function(){var innerHTML=element.innerHTML.toLowerCase();("<p>&nbsp;</p>"==innerHTML||"<p>&nbsp;</p><p>&nbsp;</p>"==innerHTML)&&(element.innerHTML="")},0)};return function(composer){dom.observe(composer.element,["cut","keydown"],clearIfNecessary)}}(),wysihtml5.quirks.ensureProperClearingOfLists=function(){var ELEMENTS_THAT_CONTAIN_LI=["OL","UL","MENU"],clearIfNecessary=function(element,contentEditableElement){if(contentEditableElement.firstChild&&wysihtml5.lang.array(ELEMENTS_THAT_CONTAIN_LI).contains(contentEditableElement.firstChild.nodeName)){var list=dom.getParentElement(element,{nodeName:ELEMENTS_THAT_CONTAIN_LI});if(list){var listIsFirstChildOfContentEditable=list==contentEditableElement.firstChild;if(listIsFirstChildOfContentEditable){var hasOnlyOneListItem=list.childNodes.length<=1;if(hasOnlyOneListItem){var onlyListItemIsEmpty=list.firstChild?""===list.firstChild.innerHTML:!0;onlyListItemIsEmpty&&list.parentNode.removeChild(list)}}}}};return function(composer){dom.observe(composer.element,"keydown",function(event){if(event.keyCode===wysihtml5.BACKSPACE_KEY){var element=composer.selection.getSelectedNode();clearIfNecessary(element,composer.element)}})}}()}(wysihtml5),function(wysihtml5){var TILDE_ESCAPED="%7E";wysihtml5.quirks.getCorrectInnerHTML=function(element){var innerHTML=element.innerHTML;if(-1===innerHTML.indexOf(TILDE_ESCAPED))return innerHTML;var url,urlToSearch,length,i,elementsWithTilde=element.querySelectorAll("[href*='~'], [src*='~']");for(i=0,length=elementsWithTilde.length;length>i;i++)url=elementsWithTilde[i].href||elementsWithTilde[i].src,urlToSearch=wysihtml5.lang.string(url).replace("~").by(TILDE_ESCAPED),innerHTML=wysihtml5.lang.string(innerHTML).replace(urlToSearch).by(url);return innerHTML}}(wysihtml5),function(wysihtml5){var dom=wysihtml5.dom,USE_NATIVE_LINE_BREAK_WHEN_CARET_INSIDE_TAGS=["LI","P","H1","H2","H3","H4","H5","H6"],LIST_TAGS=["UL","OL","MENU"];wysihtml5.quirks.insertLineBreakOnReturn=function(composer){function unwrap(selectedNode){var parentElement=dom.getParentElement(selectedNode,{nodeName:["P","DIV"]},2);if(parentElement){var invisibleSpace=document.createTextNode(wysihtml5.INVISIBLE_SPACE);dom.insert(invisibleSpace).before(parentElement),dom.replaceWithChildNodes(parentElement),composer.selection.selectNode(invisibleSpace)}}function keyDown(event){var keyCode=event.keyCode;if(!(event.shiftKey||keyCode!==wysihtml5.ENTER_KEY&&keyCode!==wysihtml5.BACKSPACE_KEY)){var selectedNode=(event.target,composer.selection.getSelectedNode()),blockElement=dom.getParentElement(selectedNode,{nodeName:USE_NATIVE_LINE_BREAK_WHEN_CARET_INSIDE_TAGS},4);return blockElement?("LI"!==blockElement.nodeName||keyCode!==wysihtml5.ENTER_KEY&&keyCode!==wysihtml5.BACKSPACE_KEY?blockElement.nodeName.match(/H[1-6]/)&&keyCode===wysihtml5.ENTER_KEY&&setTimeout(function(){unwrap(composer.selection.getSelectedNode())},0):setTimeout(function(){var list,selectedNode=composer.selection.getSelectedNode();selectedNode&&(list=dom.getParentElement(selectedNode,{nodeName:LIST_TAGS},2),list||unwrap(selectedNode))},0),void 0):(keyCode!==wysihtml5.ENTER_KEY||wysihtml5.browser.insertsLineBreaksOnReturn()||(composer.commands.exec("insertLineBreak"),event.preventDefault()),void 0)}}dom.observe(composer.element.ownerDocument,"keydown",keyDown)}}(wysihtml5),function(wysihtml5){var CLASS_NAME="wysihtml5-quirks-redraw";wysihtml5.quirks.redraw=function(element){wysihtml5.dom.addClass(element,CLASS_NAME),wysihtml5.dom.removeClass(element,CLASS_NAME);try{var doc=element.ownerDocument;doc.execCommand("italic",!1,null),doc.execCommand("italic",!1,null)}catch(e){}}}(wysihtml5),function(wysihtml5){function _getCumulativeOffsetTop(element){var top=0;if(element.parentNode)do top+=element.offsetTop||0,element=element.offsetParent;while(element);return top}var dom=wysihtml5.dom;wysihtml5.Selection=Base.extend({constructor:function(editor){window.rangy.init(),this.editor=editor,this.composer=editor.composer,this.doc=this.composer.doc},getBookmark:function(){var range=this.getRange();return range&&range.cloneRange()},setBookmark:function(bookmark){bookmark&&this.setSelection(bookmark)},setBefore:function(node){var range=rangy.createRange(this.doc);return range.setStartBefore(node),range.setEndBefore(node),this.setSelection(range)},setAfter:function(node){var range=rangy.createRange(this.doc);return range.setStartAfter(node),range.setEndAfter(node),this.setSelection(range)},selectNode:function(node){var range=rangy.createRange(this.doc),isElement=node.nodeType===wysihtml5.ELEMENT_NODE,canHaveHTML="canHaveHTML"in node?node.canHaveHTML:"IMG"!==node.nodeName,content=isElement?node.innerHTML:node.data,isEmpty=""===content||content===wysihtml5.INVISIBLE_SPACE,displayStyle=dom.getStyle("display").from(node),isBlockElement="block"===displayStyle||"list-item"===displayStyle;if(isEmpty&&isElement&&canHaveHTML)try{node.innerHTML=wysihtml5.INVISIBLE_SPACE}catch(e){}canHaveHTML?range.selectNodeContents(node):range.selectNode(node),canHaveHTML&&isEmpty&&isElement?range.collapse(isBlockElement):canHaveHTML&&isEmpty&&(range.setStartAfter(node),range.setEndAfter(node)),this.setSelection(range)},getSelectedNode:function(controlRange){var selection,range;return controlRange&&this.doc.selection&&"Control"===this.doc.selection.type&&(range=this.doc.selection.createRange(),range&&range.length)?range.item(0):(selection=this.getSelection(this.doc),selection.focusNode===selection.anchorNode?selection.focusNode:(range=this.getRange(this.doc),range?range.commonAncestorContainer:this.doc.body))},executeAndRestore:function(method,restoreScrollPosition){var newRange,body=this.doc.body,oldScrollTop=restoreScrollPosition&&body.scrollTop,oldScrollLeft=restoreScrollPosition&&body.scrollLeft,className="_wysihtml5-temp-placeholder",placeholderHTML='<span class="'+className+'">'+wysihtml5.INVISIBLE_SPACE+"</span>",range=this.getRange(this.doc);if(!range)return method(body,body),void 0;var node=range.createContextualFragment(placeholderHTML);range.insertNode(node);try{method(range.startContainer,range.endContainer)}catch(e3){setTimeout(function(){throw e3},0)}caretPlaceholder=this.doc.querySelector("."+className),caretPlaceholder?(newRange=rangy.createRange(this.doc),newRange.selectNode(caretPlaceholder),newRange.deleteContents(),this.setSelection(newRange)):body.focus(),restoreScrollPosition&&(body.scrollTop=oldScrollTop,body.scrollLeft=oldScrollLeft);try{caretPlaceholder.parentNode.removeChild(caretPlaceholder)}catch(e4){}},executeAndRestoreSimple:function(method){var newRange,firstNode,lastNode,textNodes,rangeBackup,range=this.getRange(),body=this.doc.body;if(!range)return method(body,body),void 0;textNodes=range.getNodes([3]),firstNode=textNodes[0]||range.startContainer,lastNode=textNodes[textNodes.length-1]||range.endContainer,rangeBackup={collapsed:range.collapsed,startContainer:firstNode,startOffset:firstNode===range.startContainer?range.startOffset:0,endContainer:lastNode,endOffset:lastNode===range.endContainer?range.endOffset:lastNode.length};try{method(range.startContainer,range.endContainer)}catch(e){setTimeout(function(){throw e},0)}newRange=rangy.createRange(this.doc);try{newRange.setStart(rangeBackup.startContainer,rangeBackup.startOffset)}catch(e1){}try{newRange.setEnd(rangeBackup.endContainer,rangeBackup.endOffset)}catch(e2){}try{this.setSelection(newRange)}catch(e3){}},insertHTML:function(html){var range=rangy.createRange(this.doc),node=range.createContextualFragment(html),lastChild=node.lastChild;this.insertNode(node),lastChild&&this.setAfter(lastChild)},insertNode:function(node){var range=this.getRange();range&&range.insertNode(node)},surround:function(node){var range=this.getRange();if(range)try{range.surroundContents(node),this.selectNode(node)}catch(e){node.appendChild(range.extractContents()),range.insertNode(node)}},scrollIntoView:function(){var offsetTop,doc=this.doc,hasScrollBars=doc.documentElement.scrollHeight>doc.documentElement.offsetHeight,tempElement=doc._wysihtml5ScrollIntoViewElement=doc._wysihtml5ScrollIntoViewElement||function(){var element=doc.createElement("span");return element.innerHTML=wysihtml5.INVISIBLE_SPACE,element}();hasScrollBars&&(this.insertNode(tempElement),offsetTop=_getCumulativeOffsetTop(tempElement),tempElement.parentNode.removeChild(tempElement),offsetTop>doc.body.scrollTop&&(doc.body.scrollTop=offsetTop))},selectLine:function(){wysihtml5.browser.supportsSelectionModify()?this._selectLine_W3C():this.doc.selection&&this._selectLine_MSIE()},_selectLine_W3C:function(){var win=this.doc.defaultView,selection=win.getSelection();selection.modify("extend","left","lineboundary"),selection.modify("extend","right","lineboundary")},_selectLine_MSIE:function(){var rangeBottom,rangeEnd,measureNode,i,j,range=this.doc.selection.createRange(),rangeTop=range.boundingTop,scrollWidth=(range.boundingHeight,this.doc.body.scrollWidth);if(range.moveToPoint){for(0===rangeTop&&(measureNode=this.doc.createElement("span"),this.insertNode(measureNode),rangeTop=measureNode.offsetTop,measureNode.parentNode.removeChild(measureNode)),rangeTop+=1,i=-10;scrollWidth>i;i+=2)try{range.moveToPoint(i,rangeTop);break}catch(e1){}for(rangeBottom=rangeTop,rangeEnd=this.doc.selection.createRange(),j=scrollWidth;j>=0;j--)try{rangeEnd.moveToPoint(j,rangeBottom);break}catch(e2){}range.setEndPoint("EndToEnd",rangeEnd),range.select()}},getText:function(){var selection=this.getSelection();return selection?selection.toString():""},getNodes:function(nodeType,filter){var range=this.getRange();return range?range.getNodes([nodeType],filter):[]},getRange:function(){var selection=this.getSelection();return selection&&selection.rangeCount&&selection.getRangeAt(0)},getSelection:function(){return rangy.getSelection(this.doc.defaultView||this.doc.parentWindow)},setSelection:function(range){var win=this.doc.defaultView||this.doc.parentWindow,selection=rangy.getSelection(win);return selection.setSingleRange(range)}})}(wysihtml5),function(wysihtml5,rangy){function hasClass(el,cssClass,regExp){if(!el.className)return!1;var matchingClassNames=el.className.match(regExp)||[];return matchingClassNames[matchingClassNames.length-1]===cssClass}function addClass(el,cssClass,regExp){el.className?(removeClass(el,regExp),el.className+=" "+cssClass):el.className=cssClass}function removeClass(el,regExp){el.className&&(el.className=el.className.replace(regExp,""))}function hasSameClasses(el1,el2){return el1.className.replace(REG_EXP_WHITE_SPACE," ")==el2.className.replace(REG_EXP_WHITE_SPACE," ")}function replaceWithOwnChildren(el){for(var parent=el.parentNode;el.firstChild;)parent.insertBefore(el.firstChild,el);parent.removeChild(el)}function elementsHaveSameNonClassAttributes(el1,el2){if(el1.attributes.length!=el2.attributes.length)return!1;for(var attr1,attr2,name,i=0,len=el1.attributes.length;len>i;++i)if(attr1=el1.attributes[i],name=attr1.name,"class"!=name){if(attr2=el2.attributes.getNamedItem(name),attr1.specified!=attr2.specified)return!1;if(attr1.specified&&attr1.nodeValue!==attr2.nodeValue)return!1}return!0}function isSplitPoint(node,offset){return rangy.dom.isCharacterDataNode(node)?0==offset?!!node.previousSibling:offset==node.length?!!node.nextSibling:!0:offset>0&&offset<node.childNodes.length}function splitNodeAt(node,descendantNode,descendantOffset){var newNode;if(rangy.dom.isCharacterDataNode(descendantNode)&&(0==descendantOffset?(descendantOffset=rangy.dom.getNodeIndex(descendantNode),descendantNode=descendantNode.parentNode):descendantOffset==descendantNode.length?(descendantOffset=rangy.dom.getNodeIndex(descendantNode)+1,descendantNode=descendantNode.parentNode):newNode=rangy.dom.splitDataNode(descendantNode,descendantOffset)),!newNode){newNode=descendantNode.cloneNode(!1),newNode.id&&newNode.removeAttribute("id");for(var child;child=descendantNode.childNodes[descendantOffset];)newNode.appendChild(child);rangy.dom.insertAfter(newNode,descendantNode)}return descendantNode==node?newNode:splitNodeAt(node,newNode.parentNode,rangy.dom.getNodeIndex(newNode))}function Merge(firstNode){this.isElementMerge=firstNode.nodeType==wysihtml5.ELEMENT_NODE,this.firstTextNode=this.isElementMerge?firstNode.lastChild:firstNode,this.textNodes=[this.firstTextNode]}function HTMLApplier(tagNames,cssClass,similarClassRegExp,normalize){this.tagNames=tagNames||[defaultTagName],this.cssClass=cssClass||"",this.similarClassRegExp=similarClassRegExp,this.normalize=normalize,this.applyToAnyTagName=!1}var defaultTagName="span",REG_EXP_WHITE_SPACE=/\s+/g;Merge.prototype={doMerge:function(){for(var textNode,parent,text,textBits=[],i=0,len=this.textNodes.length;len>i;++i)textNode=this.textNodes[i],parent=textNode.parentNode,textBits[i]=textNode.data,i&&(parent.removeChild(textNode),parent.hasChildNodes()||parent.parentNode.removeChild(parent));return this.firstTextNode.data=text=textBits.join(""),text},getLength:function(){for(var i=this.textNodes.length,len=0;i--;)len+=this.textNodes[i].length;return len},toString:function(){for(var textBits=[],i=0,len=this.textNodes.length;len>i;++i)textBits[i]="'"+this.textNodes[i].data+"'";return"[Merge("+textBits.join(",")+")]"}},HTMLApplier.prototype={getAncestorWithClass:function(node){for(var cssClassMatch;node;){if(cssClassMatch=this.cssClass?hasClass(node,this.cssClass,this.similarClassRegExp):!0,node.nodeType==wysihtml5.ELEMENT_NODE&&rangy.dom.arrayContains(this.tagNames,node.tagName.toLowerCase())&&cssClassMatch)return node;node=node.parentNode}return!1},postApply:function(textNodes,range){for(var currentMerge,textNode,precedingTextNode,firstNode=textNodes[0],lastNode=textNodes[textNodes.length-1],merges=[],rangeStartNode=firstNode,rangeEndNode=lastNode,rangeStartOffset=0,rangeEndOffset=lastNode.length,i=0,len=textNodes.length;len>i;++i)textNode=textNodes[i],precedingTextNode=this.getAdjacentMergeableTextNode(textNode.parentNode,!1),precedingTextNode?(currentMerge||(currentMerge=new Merge(precedingTextNode),merges.push(currentMerge)),currentMerge.textNodes.push(textNode),textNode===firstNode&&(rangeStartNode=currentMerge.firstTextNode,rangeStartOffset=rangeStartNode.length),textNode===lastNode&&(rangeEndNode=currentMerge.firstTextNode,rangeEndOffset=currentMerge.getLength())):currentMerge=null;var nextTextNode=this.getAdjacentMergeableTextNode(lastNode.parentNode,!0);if(nextTextNode&&(currentMerge||(currentMerge=new Merge(lastNode),merges.push(currentMerge)),currentMerge.textNodes.push(nextTextNode)),merges.length){for(i=0,len=merges.length;len>i;++i)merges[i].doMerge();range.setStart(rangeStartNode,rangeStartOffset),range.setEnd(rangeEndNode,rangeEndOffset)}},getAdjacentMergeableTextNode:function(node,forward){var adjacentNode,isTextNode=node.nodeType==wysihtml5.TEXT_NODE,el=isTextNode?node.parentNode:node,propName=forward?"nextSibling":"previousSibling";if(isTextNode){if(adjacentNode=node[propName],adjacentNode&&adjacentNode.nodeType==wysihtml5.TEXT_NODE)return adjacentNode}else if(adjacentNode=el[propName],adjacentNode&&this.areElementsMergeable(node,adjacentNode))return adjacentNode[forward?"firstChild":"lastChild"];return null},areElementsMergeable:function(el1,el2){return rangy.dom.arrayContains(this.tagNames,(el1.tagName||"").toLowerCase())&&rangy.dom.arrayContains(this.tagNames,(el2.tagName||"").toLowerCase())&&hasSameClasses(el1,el2)&&elementsHaveSameNonClassAttributes(el1,el2)},createContainer:function(doc){var el=doc.createElement(this.tagNames[0]);return this.cssClass&&(el.className=this.cssClass),el},applyToTextNode:function(textNode){var parent=textNode.parentNode;if(1==parent.childNodes.length&&rangy.dom.arrayContains(this.tagNames,parent.tagName.toLowerCase()))this.cssClass&&addClass(parent,this.cssClass,this.similarClassRegExp);else{var el=this.createContainer(rangy.dom.getDocument(textNode));textNode.parentNode.insertBefore(el,textNode),el.appendChild(textNode)}},isRemovable:function(el){return rangy.dom.arrayContains(this.tagNames,el.tagName.toLowerCase())&&wysihtml5.lang.string(el.className).trim()==this.cssClass},undoToTextNode:function(textNode,range,ancestorWithClass){if(!range.containsNode(ancestorWithClass)){var ancestorRange=range.cloneRange();ancestorRange.selectNode(ancestorWithClass),ancestorRange.isPointInRange(range.endContainer,range.endOffset)&&isSplitPoint(range.endContainer,range.endOffset)&&(splitNodeAt(ancestorWithClass,range.endContainer,range.endOffset),range.setEndAfter(ancestorWithClass)),ancestorRange.isPointInRange(range.startContainer,range.startOffset)&&isSplitPoint(range.startContainer,range.startOffset)&&(ancestorWithClass=splitNodeAt(ancestorWithClass,range.startContainer,range.startOffset))}this.similarClassRegExp&&removeClass(ancestorWithClass,this.similarClassRegExp),this.isRemovable(ancestorWithClass)&&replaceWithOwnChildren(ancestorWithClass)},applyToRange:function(range){var textNodes=range.getNodes([wysihtml5.TEXT_NODE]);if(!textNodes.length)try{var node=this.createContainer(range.endContainer.ownerDocument);return range.surroundContents(node),this.selectNode(range,node),void 0}catch(e){}if(range.splitBoundaries(),textNodes=range.getNodes([wysihtml5.TEXT_NODE]),textNodes.length){for(var textNode,i=0,len=textNodes.length;len>i;++i)textNode=textNodes[i],this.getAncestorWithClass(textNode)||this.applyToTextNode(textNode);range.setStart(textNodes[0],0),textNode=textNodes[textNodes.length-1],range.setEnd(textNode,textNode.length),this.normalize&&this.postApply(textNodes,range)}},undoToRange:function(range){var textNode,ancestorWithClass,textNodes=range.getNodes([wysihtml5.TEXT_NODE]);if(textNodes.length)range.splitBoundaries(),textNodes=range.getNodes([wysihtml5.TEXT_NODE]);else{var doc=range.endContainer.ownerDocument,node=doc.createTextNode(wysihtml5.INVISIBLE_SPACE);range.insertNode(node),range.selectNode(node),textNodes=[node]}for(var i=0,len=textNodes.length;len>i;++i)textNode=textNodes[i],ancestorWithClass=this.getAncestorWithClass(textNode),ancestorWithClass&&this.undoToTextNode(textNode,range,ancestorWithClass);1==len?this.selectNode(range,textNodes[0]):(range.setStart(textNodes[0],0),textNode=textNodes[textNodes.length-1],range.setEnd(textNode,textNode.length),this.normalize&&this.postApply(textNodes,range))},selectNode:function(range,node){var isElement=node.nodeType===wysihtml5.ELEMENT_NODE,canHaveHTML="canHaveHTML"in node?node.canHaveHTML:!0,content=isElement?node.innerHTML:node.data,isEmpty=""===content||content===wysihtml5.INVISIBLE_SPACE;if(isEmpty&&isElement&&canHaveHTML)try{node.innerHTML=wysihtml5.INVISIBLE_SPACE}catch(e){}range.selectNodeContents(node),isEmpty&&isElement?range.collapse(!1):isEmpty&&(range.setStartAfter(node),range.setEndAfter(node))},getTextSelectedByRange:function(textNode,range){var textRange=range.cloneRange();textRange.selectNodeContents(textNode);var intersectionRange=textRange.intersection(range),text=intersectionRange?intersectionRange.toString():"";return textRange.detach(),text},isAppliedToRange:function(range){var ancestor,ancestors=[],textNodes=range.getNodes([wysihtml5.TEXT_NODE]);if(!textNodes.length)return ancestor=this.getAncestorWithClass(range.startContainer),ancestor?[ancestor]:!1;for(var selectedText,i=0,len=textNodes.length;len>i;++i){if(selectedText=this.getTextSelectedByRange(textNodes[i],range),ancestor=this.getAncestorWithClass(textNodes[i]),""!=selectedText&&!ancestor)return!1;ancestors.push(ancestor)}return ancestors},toggleRange:function(range){this.isAppliedToRange(range)?this.undoToRange(range):this.applyToRange(range)}},wysihtml5.selection.HTMLApplier=HTMLApplier}(wysihtml5,rangy),wysihtml5.Commands=Base.extend({constructor:function(editor){this.editor=editor,this.composer=editor.composer,this.doc=this.composer.doc},support:function(command){return wysihtml5.browser.supportsCommand(this.doc,command)},exec:function(command,value){var obj=wysihtml5.commands[command],args=wysihtml5.lang.array(arguments).get(),method=obj&&obj.exec,result=null;if(this.editor.fire("beforecommand:composer"),method)args.unshift(this.composer),result=method.apply(obj,args);else try{result=this.doc.execCommand(command,!1,value)}catch(e){}return this.editor.fire("aftercommand:composer"),result},state:function(command){var obj=wysihtml5.commands[command],args=wysihtml5.lang.array(arguments).get(),method=obj&&obj.state;if(method)return args.unshift(this.composer),method.apply(obj,args);try{return this.doc.queryCommandState(command)}catch(e){return!1}},value:function(command){var obj=wysihtml5.commands[command],method=obj&&obj.value;if(method)return method.call(obj,this.composer,command);try{return this.doc.queryCommandValue(command)}catch(e){return null}}}),function(wysihtml5){var undef;wysihtml5.commands.bold={exec:function(composer,command){return wysihtml5.commands.formatInline.exec(composer,command,"b")},state:function(composer,command){return wysihtml5.commands.formatInline.state(composer,command,"b")},value:function(){return undef}}}(wysihtml5),function(wysihtml5){function _removeFormat(composer,anchors){for(var anchor,codeElement,textContent,length=anchors.length,i=0;length>i;i++)anchor=anchors[i],codeElement=dom.getParentElement(anchor,{nodeName:"code"}),textContent=dom.getTextContent(anchor),textContent.match(dom.autoLink.URL_REG_EXP)&&!codeElement?codeElement=dom.renameElement(anchor,"code"):dom.replaceWithChildNodes(anchor)}function _format(composer,attributes){var length,anchors,anchor,hasElementChild,isEmpty,elementToSetCaretAfter,textContent,whiteSpace,j,doc=composer.doc,tempClass="_wysihtml5-temp-"+ +new Date,tempClassRegExp=/non-matching-class/g,i=0;for(wysihtml5.commands.formatInline.exec(composer,undef,NODE_NAME,tempClass,tempClassRegExp),anchors=doc.querySelectorAll(NODE_NAME+"."+tempClass),length=anchors.length;length>i;i++){anchor=anchors[i],anchor.removeAttribute("class");for(j in attributes)anchor.setAttribute(j,attributes[j])}elementToSetCaretAfter=anchor,1===length&&(textContent=dom.getTextContent(anchor),hasElementChild=!!anchor.querySelector("*"),isEmpty=""===textContent||textContent===wysihtml5.INVISIBLE_SPACE,!hasElementChild&&isEmpty&&(dom.setTextContent(anchor,attributes.text||anchor.href),whiteSpace=doc.createTextNode(" "),composer.selection.setAfter(anchor),composer.selection.insertNode(whiteSpace),elementToSetCaretAfter=whiteSpace)),composer.selection.setAfter(elementToSetCaretAfter)}var undef,NODE_NAME="A",dom=wysihtml5.dom;wysihtml5.commands.createLink={exec:function(composer,command,value){var anchors=this.state(composer,command);anchors?composer.selection.executeAndRestore(function(){_removeFormat(composer,anchors)}):(value="object"==typeof value?value:{href:value},_format(composer,value))},state:function(composer,command){return wysihtml5.commands.formatInline.state(composer,command,"A")},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var undef,REG_EXP=/wysiwyg-font-size-[a-z\-]+/g;wysihtml5.commands.fontSize={exec:function(composer,command,size){return wysihtml5.commands.formatInline.exec(composer,command,"span","wysiwyg-font-size-"+size,REG_EXP)},state:function(composer,command,size){return wysihtml5.commands.formatInline.state(composer,command,"span","wysiwyg-font-size-"+size,REG_EXP)},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var undef,REG_EXP=/wysiwyg-color-[a-z]+/g;wysihtml5.commands.foreColor={exec:function(composer,command,color){return wysihtml5.commands.formatInline.exec(composer,command,"span","wysiwyg-color-"+color,REG_EXP)},state:function(composer,command,color){return wysihtml5.commands.formatInline.state(composer,command,"span","wysiwyg-color-"+color,REG_EXP)},value:function(){return undef}}}(wysihtml5),function(wysihtml5){function _addClass(element,className,classRegExp){element.className?(_removeClass(element,classRegExp),element.className+=" "+className):element.className=className}function _removeClass(element,classRegExp){element.className=element.className.replace(classRegExp,"")}function _isBlankTextNode(node){return node.nodeType===wysihtml5.TEXT_NODE&&!wysihtml5.lang.string(node.data).trim()}function _getPreviousSiblingThatIsNotBlank(node){for(var previousSibling=node.previousSibling;previousSibling&&_isBlankTextNode(previousSibling);)previousSibling=previousSibling.previousSibling;return previousSibling}function _getNextSiblingThatIsNotBlank(node){for(var nextSibling=node.nextSibling;nextSibling&&_isBlankTextNode(nextSibling);)nextSibling=nextSibling.nextSibling;return nextSibling}function _addLineBreakBeforeAndAfter(node){var doc=node.ownerDocument,nextSibling=_getNextSiblingThatIsNotBlank(node),previousSibling=_getPreviousSiblingThatIsNotBlank(node);nextSibling&&!_isLineBreakOrBlockElement(nextSibling)&&node.parentNode.insertBefore(doc.createElement("br"),nextSibling),previousSibling&&!_isLineBreakOrBlockElement(previousSibling)&&node.parentNode.insertBefore(doc.createElement("br"),node)}function _removeLineBreakBeforeAndAfter(node){var nextSibling=_getNextSiblingThatIsNotBlank(node),previousSibling=_getPreviousSiblingThatIsNotBlank(node);nextSibling&&_isLineBreak(nextSibling)&&nextSibling.parentNode.removeChild(nextSibling),previousSibling&&_isLineBreak(previousSibling)&&previousSibling.parentNode.removeChild(previousSibling)}function _removeLastChildIfLineBreak(node){var lastChild=node.lastChild;lastChild&&_isLineBreak(lastChild)&&lastChild.parentNode.removeChild(lastChild)}function _isLineBreak(node){return"BR"===node.nodeName}function _isLineBreakOrBlockElement(element){return _isLineBreak(element)?!0:"block"===dom.getStyle("display").from(element)?!0:!1}function _execCommand(doc,command,nodeName,className){if(className)var eventListener=dom.observe(doc,"DOMNodeInserted",function(event){var displayStyle,target=event.target;target.nodeType===wysihtml5.ELEMENT_NODE&&(displayStyle=dom.getStyle("display").from(target),"inline"!==displayStyle.substr(0,6)&&(target.className+=" "+className))});doc.execCommand(command,!1,nodeName),eventListener&&eventListener.stop()}function _selectLineAndWrap(composer,element){composer.selection.selectLine(),composer.selection.surround(element),_removeLineBreakBeforeAndAfter(element),_removeLastChildIfLineBreak(element),composer.selection.selectNode(element)}function _hasClasses(element){return!!wysihtml5.lang.string(element.className).trim()}var undef,dom=wysihtml5.dom,DEFAULT_NODE_NAME="DIV",BLOCK_ELEMENTS_GROUP=["H1","H2","H3","H4","H5","H6","P","BLOCKQUOTE",DEFAULT_NODE_NAME];wysihtml5.commands.formatBlock={exec:function(composer,command,nodeName,className,classRegExp){var selectedNode,doc=composer.doc,blockElement=this.state(composer,command,nodeName,className,classRegExp);return nodeName="string"==typeof nodeName?nodeName.toUpperCase():nodeName,blockElement?(composer.selection.executeAndRestoreSimple(function(){classRegExp&&_removeClass(blockElement,classRegExp);var hasClasses=_hasClasses(blockElement);hasClasses||blockElement.nodeName!==(nodeName||DEFAULT_NODE_NAME)?hasClasses&&dom.renameElement(blockElement,DEFAULT_NODE_NAME):(_addLineBreakBeforeAndAfter(blockElement),dom.replaceWithChildNodes(blockElement))}),void 0):(null===nodeName||wysihtml5.lang.array(BLOCK_ELEMENTS_GROUP).contains(nodeName))&&(selectedNode=composer.selection.getSelectedNode(),blockElement=dom.getParentElement(selectedNode,{nodeName:BLOCK_ELEMENTS_GROUP}))?(composer.selection.executeAndRestoreSimple(function(){nodeName&&(blockElement=dom.renameElement(blockElement,nodeName)),className&&_addClass(blockElement,className,classRegExp)}),void 0):composer.commands.support(command)?(_execCommand(doc,command,nodeName||DEFAULT_NODE_NAME,className),void 0):(blockElement=doc.createElement(nodeName||DEFAULT_NODE_NAME),className&&(blockElement.className=className),_selectLineAndWrap(composer,blockElement),void 0)},state:function(composer,command,nodeName,className,classRegExp){nodeName="string"==typeof nodeName?nodeName.toUpperCase():nodeName;var selectedNode=composer.selection.getSelectedNode();return dom.getParentElement(selectedNode,{nodeName:nodeName,className:className,classRegExp:classRegExp})},value:function(){return undef}}}(wysihtml5),function(wysihtml5){function _getTagNames(tagName){var alias=ALIAS_MAPPING[tagName];return alias?[tagName.toLowerCase(),alias.toLowerCase()]:[tagName.toLowerCase()]}function _getApplier(tagName,className,classRegExp){var identifier=tagName+":"+className;return htmlApplier[identifier]||(htmlApplier[identifier]=new wysihtml5.selection.HTMLApplier(_getTagNames(tagName),className,classRegExp,!0)),htmlApplier[identifier]}var undef,ALIAS_MAPPING={strong:"b",em:"i",b:"strong",i:"em"},htmlApplier={};wysihtml5.commands.formatInline={exec:function(composer,command,tagName,className,classRegExp){var range=composer.selection.getRange();return range?(_getApplier(tagName,className,classRegExp).toggleRange(range),composer.selection.setSelection(range),void 0):!1},state:function(composer,command,tagName,className,classRegExp){var range,doc=composer.doc,aliasTagName=ALIAS_MAPPING[tagName]||tagName;return wysihtml5.dom.hasElementWithTagName(doc,tagName)||wysihtml5.dom.hasElementWithTagName(doc,aliasTagName)?className&&!wysihtml5.dom.hasElementWithClassName(doc,className)?!1:(range=composer.selection.getRange(),range?_getApplier(tagName,className,classRegExp).isAppliedToRange(range):!1):!1},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var undef;wysihtml5.commands.insertHTML={exec:function(composer,command,html){composer.commands.support(command)?composer.doc.execCommand(command,!1,html):composer.selection.insertHTML(html)},state:function(){return!1},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var NODE_NAME="IMG";wysihtml5.commands.insertImage={exec:function(composer,command,value){value="object"==typeof value?value:{src:value};
var textNode,i,parent,doc=composer.doc,image=this.state(composer);if(image)return composer.selection.setBefore(image),parent=image.parentNode,parent.removeChild(image),wysihtml5.dom.removeEmptyTextNodes(parent),"A"!==parent.nodeName||parent.firstChild||(composer.selection.setAfter(parent),parent.parentNode.removeChild(parent)),wysihtml5.quirks.redraw(composer.element),void 0;image=doc.createElement(NODE_NAME);for(i in value)image[i]=value[i];composer.selection.insertNode(image),wysihtml5.browser.hasProblemsSettingCaretAfterImg()?(textNode=doc.createTextNode(wysihtml5.INVISIBLE_SPACE),composer.selection.insertNode(textNode),composer.selection.setAfter(textNode)):composer.selection.setAfter(image)},state:function(composer){var selectedNode,text,imagesInSelection,doc=composer.doc;return wysihtml5.dom.hasElementWithTagName(doc,NODE_NAME)?(selectedNode=composer.selection.getSelectedNode())?selectedNode.nodeName===NODE_NAME?selectedNode:selectedNode.nodeType!==wysihtml5.ELEMENT_NODE?!1:(text=composer.selection.getText(),(text=wysihtml5.lang.string(text).trim())?!1:(imagesInSelection=composer.selection.getNodes(wysihtml5.ELEMENT_NODE,function(node){return"IMG"===node.nodeName}),1!==imagesInSelection.length?!1:imagesInSelection[0])):!1:!1},value:function(composer){var image=this.state(composer);return image&&image.src}}}(wysihtml5),function(wysihtml5){var undef,LINE_BREAK="<br>"+(wysihtml5.browser.needsSpaceAfterLineBreak()?" ":"");wysihtml5.commands.insertLineBreak={exec:function(composer,command){composer.commands.support(command)?(composer.doc.execCommand(command,!1,null),wysihtml5.browser.autoScrollsToCaret()||composer.selection.scrollIntoView()):composer.commands.exec("insertHTML",LINE_BREAK)},state:function(){return!1},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var undef;wysihtml5.commands.insertOrderedList={exec:function(composer,command){var isEmpty,tempElement,doc=composer.doc,selectedNode=composer.selection.getSelectedNode(),list=wysihtml5.dom.getParentElement(selectedNode,{nodeName:"OL"}),otherList=wysihtml5.dom.getParentElement(selectedNode,{nodeName:"UL"}),tempClassName="_wysihtml5-temp-"+(new Date).getTime();return composer.commands.support(command)?(doc.execCommand(command,!1,null),void 0):(list?composer.selection.executeAndRestoreSimple(function(){wysihtml5.dom.resolveList(list)}):otherList?composer.selection.executeAndRestoreSimple(function(){wysihtml5.dom.renameElement(otherList,"ol")}):(composer.commands.exec("formatBlock","div",tempClassName),tempElement=doc.querySelector("."+tempClassName),isEmpty=""===tempElement.innerHTML||tempElement.innerHTML===wysihtml5.INVISIBLE_SPACE,composer.selection.executeAndRestoreSimple(function(){list=wysihtml5.dom.convertToList(tempElement,"ol")}),isEmpty&&composer.selection.selectNode(list.querySelector("li"))),void 0)},state:function(composer){var selectedNode=composer.selection.getSelectedNode();return wysihtml5.dom.getParentElement(selectedNode,{nodeName:"OL"})},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var undef;wysihtml5.commands.insertUnorderedList={exec:function(composer,command){var isEmpty,tempElement,doc=composer.doc,selectedNode=composer.selection.getSelectedNode(),list=wysihtml5.dom.getParentElement(selectedNode,{nodeName:"UL"}),otherList=wysihtml5.dom.getParentElement(selectedNode,{nodeName:"OL"}),tempClassName="_wysihtml5-temp-"+(new Date).getTime();return composer.commands.support(command)?(doc.execCommand(command,!1,null),void 0):(list?composer.selection.executeAndRestoreSimple(function(){wysihtml5.dom.resolveList(list)}):otherList?composer.selection.executeAndRestoreSimple(function(){wysihtml5.dom.renameElement(otherList,"ul")}):(composer.commands.exec("formatBlock","div",tempClassName),tempElement=doc.querySelector("."+tempClassName),isEmpty=""===tempElement.innerHTML||tempElement.innerHTML===wysihtml5.INVISIBLE_SPACE,composer.selection.executeAndRestoreSimple(function(){list=wysihtml5.dom.convertToList(tempElement,"ul")}),isEmpty&&composer.selection.selectNode(list.querySelector("li"))),void 0)},state:function(composer){var selectedNode=composer.selection.getSelectedNode();return wysihtml5.dom.getParentElement(selectedNode,{nodeName:"UL"})},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var undef;wysihtml5.commands.italic={exec:function(composer,command){return wysihtml5.commands.formatInline.exec(composer,command,"i")},state:function(composer,command){return wysihtml5.commands.formatInline.state(composer,command,"i")},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var undef,CLASS_NAME="wysiwyg-text-align-center",REG_EXP=/wysiwyg-text-align-[a-z]+/g;wysihtml5.commands.justifyCenter={exec:function(composer){return wysihtml5.commands.formatBlock.exec(composer,"formatBlock",null,CLASS_NAME,REG_EXP)},state:function(composer){return wysihtml5.commands.formatBlock.state(composer,"formatBlock",null,CLASS_NAME,REG_EXP)},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var undef,CLASS_NAME="wysiwyg-text-align-left",REG_EXP=/wysiwyg-text-align-[a-z]+/g;wysihtml5.commands.justifyLeft={exec:function(composer){return wysihtml5.commands.formatBlock.exec(composer,"formatBlock",null,CLASS_NAME,REG_EXP)},state:function(composer){return wysihtml5.commands.formatBlock.state(composer,"formatBlock",null,CLASS_NAME,REG_EXP)},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var undef,CLASS_NAME="wysiwyg-text-align-right",REG_EXP=/wysiwyg-text-align-[a-z]+/g;wysihtml5.commands.justifyRight={exec:function(composer){return wysihtml5.commands.formatBlock.exec(composer,"formatBlock",null,CLASS_NAME,REG_EXP)},state:function(composer){return wysihtml5.commands.formatBlock.state(composer,"formatBlock",null,CLASS_NAME,REG_EXP)},value:function(){return undef}}}(wysihtml5),function(wysihtml5){var undef;wysihtml5.commands.underline={exec:function(composer,command){return wysihtml5.commands.formatInline.exec(composer,command,"u")},state:function(composer,command){return wysihtml5.commands.formatInline.state(composer,command,"u")},value:function(){return undef}}}(wysihtml5),function(wysihtml5){function cleanTempElements(doc){for(var tempElement;tempElement=doc.querySelector("._wysihtml5-temp");)tempElement.parentNode.removeChild(tempElement)}var Z_KEY=90,Y_KEY=89,BACKSPACE_KEY=8,DELETE_KEY=46,MAX_HISTORY_ENTRIES=40,UNDO_HTML='<span id="_wysihtml5-undo" class="_wysihtml5-temp">'+wysihtml5.INVISIBLE_SPACE+"</span>",REDO_HTML='<span id="_wysihtml5-redo" class="_wysihtml5-temp">'+wysihtml5.INVISIBLE_SPACE+"</span>",dom=wysihtml5.dom;wysihtml5.UndoManager=wysihtml5.lang.Dispatcher.extend({constructor:function(editor){this.editor=editor,this.composer=editor.composer,this.element=this.composer.element,this.history=[this.composer.getValue()],this.position=1,this.composer.commands.support("insertHTML")&&this._observe()},_observe:function(){var lastKey,that=this,doc=this.composer.sandbox.getDocument();if(dom.observe(this.element,"keydown",function(event){if(!event.altKey&&(event.ctrlKey||event.metaKey)){var keyCode=event.keyCode,isUndo=keyCode===Z_KEY&&!event.shiftKey,isRedo=keyCode===Z_KEY&&event.shiftKey||keyCode===Y_KEY;isUndo?(that.undo(),event.preventDefault()):isRedo&&(that.redo(),event.preventDefault())}}),dom.observe(this.element,"keydown",function(event){var keyCode=event.keyCode;keyCode!==lastKey&&(lastKey=keyCode,(keyCode===BACKSPACE_KEY||keyCode===DELETE_KEY)&&that.transact())}),wysihtml5.browser.hasUndoInContextMenu()){var interval,observed,cleanUp=function(){cleanTempElements(doc),clearInterval(interval)};dom.observe(this.element,"contextmenu",function(){cleanUp(),that.composer.selection.executeAndRestoreSimple(function(){that.element.lastChild&&that.composer.selection.setAfter(that.element.lastChild),doc.execCommand("insertHTML",!1,UNDO_HTML),doc.execCommand("insertHTML",!1,REDO_HTML),doc.execCommand("undo",!1,null)}),interval=setInterval(function(){doc.getElementById("_wysihtml5-redo")?(cleanUp(),that.redo()):doc.getElementById("_wysihtml5-undo")||(cleanUp(),that.undo())},400),observed||(observed=!0,dom.observe(document,"mousedown",cleanUp),dom.observe(doc,["mousedown","paste","cut","copy"],cleanUp))})}this.editor.observe("newword:composer",function(){that.transact()}).observe("beforecommand:composer",function(){that.transact()})},transact:function(){var previousHtml=this.history[this.position-1],currentHtml=this.composer.getValue();if(currentHtml!=previousHtml){var length=this.history.length=this.position;length>MAX_HISTORY_ENTRIES&&(this.history.shift(),this.position--),this.position++,this.history.push(currentHtml)}},undo:function(){this.transact(),this.position<=1||(this.set(this.history[--this.position-1]),this.editor.fire("undo:composer"))},redo:function(){this.position>=this.history.length||(this.set(this.history[++this.position-1]),this.editor.fire("redo:composer"))},set:function(html){this.composer.setValue(html),this.editor.focus(!0)}})}(wysihtml5),wysihtml5.views.View=Base.extend({constructor:function(parent,textareaElement,config){this.parent=parent,this.element=textareaElement,this.config=config,this._observeViewChange()},_observeViewChange:function(){var that=this;this.parent.observe("beforeload",function(){that.parent.observe("change_view",function(view){view===that.name?(that.parent.currentView=that,that.show(),setTimeout(function(){that.focus()},0)):that.hide()})})},focus:function(){if(this.element.ownerDocument.querySelector(":focus")!==this.element)try{this.element.focus()}catch(e){}},hide:function(){this.element.style.display="none"},show:function(){this.element.style.display=""},disable:function(){this.element.setAttribute("disabled","disabled")},enable:function(){this.element.removeAttribute("disabled")}}),function(wysihtml5){var dom=wysihtml5.dom,browser=wysihtml5.browser;wysihtml5.views.Composer=wysihtml5.views.View.extend({name:"composer",CARET_HACK:"<br>",constructor:function(parent,textareaElement,config){this.base(parent,textareaElement,config),this.textarea=this.parent.textarea,this._initSandbox()},clear:function(){this.element.innerHTML=browser.displaysCaretInEmptyContentEditableCorrectly()?"":this.CARET_HACK},getValue:function(parse){var value=this.isEmpty()?"":wysihtml5.quirks.getCorrectInnerHTML(this.element);return parse&&(value=this.parent.parse(value)),value=wysihtml5.lang.string(value).replace(wysihtml5.INVISIBLE_SPACE).by("")},setValue:function(html,parse){parse&&(html=this.parent.parse(html)),this.element.innerHTML=html},show:function(){this.iframe.style.display=this._displayStyle||"",this.disable(),this.enable()},hide:function(){this._displayStyle=dom.getStyle("display").from(this.iframe),"none"===this._displayStyle&&(this._displayStyle=null),this.iframe.style.display="none"},disable:function(){this.element.removeAttribute("contentEditable"),this.base()},enable:function(){this.element.setAttribute("contentEditable","true"),this.base()},focus:function(setToEnd){wysihtml5.browser.doesAsyncFocus()&&this.hasPlaceholderSet()&&this.clear(),this.base();var lastChild=this.element.lastChild;setToEnd&&lastChild&&("BR"===lastChild.nodeName?this.selection.setBefore(this.element.lastChild):this.selection.setAfter(this.element.lastChild))},getTextContent:function(){return dom.getTextContent(this.element)},hasPlaceholderSet:function(){return this.getTextContent()==this.textarea.element.getAttribute("placeholder")},isEmpty:function(){var innerHTML=this.element.innerHTML,elementsWithVisualValue="blockquote, ul, ol, img, embed, object, table, iframe, svg, video, audio, button, input, select, textarea";return""===innerHTML||innerHTML===this.CARET_HACK||this.hasPlaceholderSet()||""===this.getTextContent()&&!this.element.querySelector(elementsWithVisualValue)},_initSandbox:function(){var that=this;this.sandbox=new dom.Sandbox(function(){that._create()},{stylesheets:this.config.stylesheets}),this.iframe=this.sandbox.getIframe();var hiddenField=document.createElement("input");hiddenField.type="hidden",hiddenField.name="_wysihtml5_mode",hiddenField.value=1;var textareaElement=this.textarea.element;dom.insert(this.iframe).after(textareaElement),dom.insert(hiddenField).after(textareaElement)},_create:function(){var that=this;this.doc=this.sandbox.getDocument(),this.element=this.doc.body,this.textarea=this.parent.textarea,this.element.innerHTML=this.textarea.getValue(!0),this.enable(),this.selection=new wysihtml5.Selection(this.parent),this.commands=new wysihtml5.Commands(this.parent),dom.copyAttributes(["className","spellcheck","title","lang","dir","accessKey"]).from(this.textarea.element).to(this.element),dom.addClass(this.element,this.config.composerClassName),this.config.style&&this.style(),this.observe();var name=this.config.name;name&&(dom.addClass(this.element,name),dom.addClass(this.iframe,name));var placeholderText="string"==typeof this.config.placeholder?this.config.placeholder:this.textarea.element.getAttribute("placeholder");placeholderText&&dom.simulatePlaceholder(this.parent,this,placeholderText),this.commands.exec("styleWithCSS",!1),this._initAutoLinking(),this._initObjectResizing(),this._initUndoManager(),(this.textarea.element.hasAttribute("autofocus")||document.querySelector(":focus")==this.textarea.element)&&setTimeout(function(){that.focus()},100),wysihtml5.quirks.insertLineBreakOnReturn(this),browser.clearsContentEditableCorrectly()||wysihtml5.quirks.ensureProperClearing(this),browser.clearsListsInContentEditableCorrectly()||wysihtml5.quirks.ensureProperClearingOfLists(this),this.initSync&&this.config.sync&&this.initSync(),this.textarea.hide(),this.parent.fire("beforeload").fire("load")},_initAutoLinking:function(){var that=this,supportsDisablingOfAutoLinking=browser.canDisableAutoLinking(),supportsAutoLinking=browser.doesAutoLinkingInContentEditable();if(supportsDisablingOfAutoLinking&&this.commands.exec("autoUrlDetect",!1),this.config.autoLink){(!supportsAutoLinking||supportsAutoLinking&&supportsDisablingOfAutoLinking)&&this.parent.observe("newword:composer",function(){that.selection.executeAndRestore(function(startContainer,endContainer){dom.autoLink(endContainer.parentNode)})});var links=this.sandbox.getDocument().getElementsByTagName("a"),urlRegExp=dom.autoLink.URL_REG_EXP,getTextContent=function(element){var textContent=wysihtml5.lang.string(dom.getTextContent(element)).trim();return"www."===textContent.substr(0,4)&&(textContent="http://"+textContent),textContent};dom.observe(this.element,"keydown",function(event){if(links.length){var textContent,selectedNode=that.selection.getSelectedNode(event.target.ownerDocument),link=dom.getParentElement(selectedNode,{nodeName:"A"},4);link&&(textContent=getTextContent(link),setTimeout(function(){var newTextContent=getTextContent(link);newTextContent!==textContent&&newTextContent.match(urlRegExp)&&link.setAttribute("href",newTextContent)},0))}})}},_initObjectResizing:function(){var properties=["width","height"],propertiesLength=properties.length,element=this.element;this.commands.exec("enableObjectResizing",this.config.allowObjectResizing),this.config.allowObjectResizing?browser.supportsEvent("resizeend")&&dom.observe(element,"resizeend",function(event){for(var property,target=event.target||event.srcElement,style=target.style,i=0;propertiesLength>i;i++)property=properties[i],style[property]&&(target.setAttribute(property,parseInt(style[property],10)),style[property]="");wysihtml5.quirks.redraw(element)}):browser.supportsEvent("resizestart")&&dom.observe(element,"resizestart",function(event){event.preventDefault()})},_initUndoManager:function(){new wysihtml5.UndoManager(this.parent)}})}(wysihtml5),function(wysihtml5){var dom=wysihtml5.dom,doc=document,win=window,HOST_TEMPLATE=doc.createElement("div"),TEXT_FORMATTING=["background-color","color","cursor","font-family","font-size","font-style","font-variant","font-weight","line-height","letter-spacing","text-align","text-decoration","text-indent","text-rendering","word-break","word-wrap","word-spacing"],BOX_FORMATTING=["background-color","border-collapse","border-bottom-color","border-bottom-style","border-bottom-width","border-left-color","border-left-style","border-left-width","border-right-color","border-right-style","border-right-width","border-top-color","border-top-style","border-top-width","clear","display","float","margin-bottom","margin-left","margin-right","margin-top","outline-color","outline-offset","outline-width","outline-style","padding-left","padding-right","padding-top","padding-bottom","position","top","left","right","bottom","z-index","vertical-align","text-align","-webkit-box-sizing","-moz-box-sizing","-ms-box-sizing","box-sizing","-webkit-box-shadow","-moz-box-shadow","-ms-box-shadow","box-shadow","-webkit-border-top-right-radius","-moz-border-radius-topright","border-top-right-radius","-webkit-border-bottom-right-radius","-moz-border-radius-bottomright","border-bottom-right-radius","-webkit-border-bottom-left-radius","-moz-border-radius-bottomleft","border-bottom-left-radius","-webkit-border-top-left-radius","-moz-border-radius-topleft","border-top-left-radius","width","height"],RESIZE_STYLE=["width","height","top","left","right","bottom"],ADDITIONAL_CSS_RULES=["html             { height: 100%; }","body             { min-height: 100%; padding: 0; margin: 0; margin-top: -1px; padding-top: 1px; }","._wysihtml5-temp { display: none; }",wysihtml5.browser.isGecko?"body.placeholder { color: graytext !important; }":"body.placeholder { color: #a9a9a9 !important; }","body[disabled]   { background-color: #eee !important; color: #999 !important; cursor: default !important; }","img:-moz-broken  { -moz-force-broken-image-icon: 1; height: 24px; width: 24px; }"],focusWithoutScrolling=function(element){if(element.setActive)try{element.setActive()}catch(e){}else{var elementStyle=element.style,originalScrollTop=doc.documentElement.scrollTop||doc.body.scrollTop,originalScrollLeft=doc.documentElement.scrollLeft||doc.body.scrollLeft,originalStyles={position:elementStyle.position,top:elementStyle.top,left:elementStyle.left,WebkitUserSelect:elementStyle.WebkitUserSelect};dom.setStyles({position:"absolute",top:"-99999px",left:"-99999px",WebkitUserSelect:"none"}).on(element),element.focus(),dom.setStyles(originalStyles).on(element),win.scrollTo&&win.scrollTo(originalScrollLeft,originalScrollTop)}};wysihtml5.views.Composer.prototype.style=function(){var that=this,originalActiveElement=doc.querySelector(":focus"),textareaElement=this.textarea.element,hasPlaceholder=textareaElement.hasAttribute("placeholder"),originalPlaceholder=hasPlaceholder&&textareaElement.getAttribute("placeholder");this.focusStylesHost=this.focusStylesHost||HOST_TEMPLATE.cloneNode(!1),this.blurStylesHost=this.blurStylesHost||HOST_TEMPLATE.cloneNode(!1),hasPlaceholder&&textareaElement.removeAttribute("placeholder"),textareaElement===originalActiveElement&&textareaElement.blur(),dom.copyStyles(BOX_FORMATTING).from(textareaElement).to(this.iframe).andTo(this.blurStylesHost),dom.copyStyles(TEXT_FORMATTING).from(textareaElement).to(this.element).andTo(this.blurStylesHost),dom.insertCSS(ADDITIONAL_CSS_RULES).into(this.element.ownerDocument),focusWithoutScrolling(textareaElement),dom.copyStyles(BOX_FORMATTING).from(textareaElement).to(this.focusStylesHost),dom.copyStyles(TEXT_FORMATTING).from(textareaElement).to(this.focusStylesHost);var boxFormattingStyles=wysihtml5.lang.array(BOX_FORMATTING).without(["display"]);if(originalActiveElement?originalActiveElement.focus():textareaElement.blur(),hasPlaceholder&&textareaElement.setAttribute("placeholder",originalPlaceholder),!wysihtml5.browser.hasCurrentStyleProperty())var winObserver=dom.observe(win,"resize",function(){if(!dom.contains(document.documentElement,that.iframe))return winObserver.stop(),void 0;var originalTextareaDisplayStyle=dom.getStyle("display").from(textareaElement),originalComposerDisplayStyle=dom.getStyle("display").from(that.iframe);textareaElement.style.display="",that.iframe.style.display="none",dom.copyStyles(RESIZE_STYLE).from(textareaElement).to(that.iframe).andTo(that.focusStylesHost).andTo(that.blurStylesHost),that.iframe.style.display=originalComposerDisplayStyle,textareaElement.style.display=originalTextareaDisplayStyle});return this.parent.observe("focus:composer",function(){dom.copyStyles(boxFormattingStyles).from(that.focusStylesHost).to(that.iframe),dom.copyStyles(TEXT_FORMATTING).from(that.focusStylesHost).to(that.element)}),this.parent.observe("blur:composer",function(){dom.copyStyles(boxFormattingStyles).from(that.blurStylesHost).to(that.iframe),dom.copyStyles(TEXT_FORMATTING).from(that.blurStylesHost).to(that.element)}),this}}(wysihtml5),function(wysihtml5){var dom=wysihtml5.dom,browser=wysihtml5.browser,shortcuts={66:"bold",73:"italic",85:"underline"};wysihtml5.views.Composer.prototype.observe=function(){var that=this,state=this.getValue(),iframe=this.sandbox.getIframe(),element=this.element,focusBlurElement=browser.supportsEventsInIframeCorrectly()?element:this.sandbox.getWindow(),pasteEvents=browser.supportsEvent("drop")?["drop","paste"]:["dragdrop","paste"];dom.observe(iframe,"DOMNodeRemoved",function(){clearInterval(domNodeRemovedInterval),that.parent.fire("destroy:composer")});var domNodeRemovedInterval=setInterval(function(){dom.contains(document.documentElement,iframe)||(clearInterval(domNodeRemovedInterval),that.parent.fire("destroy:composer"))},250);dom.observe(focusBlurElement,"focus",function(){that.parent.fire("focus").fire("focus:composer"),setTimeout(function(){state=that.getValue()},0)}),dom.observe(focusBlurElement,"blur",function(){state!==that.getValue()&&that.parent.fire("change").fire("change:composer"),that.parent.fire("blur").fire("blur:composer")}),wysihtml5.browser.isIos()&&dom.observe(element,"blur",function(){var input=element.ownerDocument.createElement("input"),originalScrollTop=document.documentElement.scrollTop||document.body.scrollTop,originalScrollLeft=document.documentElement.scrollLeft||document.body.scrollLeft;try{that.selection.insertNode(input)}catch(e){element.appendChild(input)}input.focus(),input.parentNode.removeChild(input),window.scrollTo(originalScrollLeft,originalScrollTop)}),dom.observe(element,"dragenter",function(){that.parent.fire("unset_placeholder")}),browser.firesOnDropOnlyWhenOnDragOverIsCancelled()&&dom.observe(element,["dragover","dragenter"],function(event){event.preventDefault()}),dom.observe(element,pasteEvents,function(event){var data,dataTransfer=event.dataTransfer;console.log("PASTED",event),dataTransfer&&browser.supportsDataTransfer()&&(data=dataTransfer.getData("text/html")||dataTransfer.getData("text/plain")),data?(element.focus(),that.commands.exec("insertHTML",data),that.parent.fire("paste").fire("paste:composer"),event.stopPropagation(),event.preventDefault()):setTimeout(function(){that.parent.fire("paste").fire("paste:composer")},0)}),dom.observe(element,"keyup",function(event){var keyCode=event.keyCode;(keyCode===wysihtml5.SPACE_KEY||keyCode===wysihtml5.ENTER_KEY)&&that.parent.fire("newword:composer")}),this.parent.observe("paste:composer",function(){setTimeout(function(){that.parent.fire("newword:composer")},0)}),browser.canSelectImagesInContentEditable()||dom.observe(element,"mousedown",function(event){var target=event.target;"IMG"===target.nodeName&&(that.selection.selectNode(target),event.preventDefault())}),dom.observe(element,"keydown",function(event){var keyCode=event.keyCode,command=shortcuts[keyCode];(event.ctrlKey||event.metaKey)&&!event.altKey&&command&&(that.commands.exec(command),event.preventDefault())}),dom.observe(element,"keydown",function(event){var parent,target=that.selection.getSelectedNode(!0),keyCode=event.keyCode;!target||"IMG"!==target.nodeName||keyCode!==wysihtml5.BACKSPACE_KEY&&keyCode!==wysihtml5.DELETE_KEY||(parent=target.parentNode,parent.removeChild(target),"A"!==parent.nodeName||parent.firstChild||parent.parentNode.removeChild(parent),setTimeout(function(){wysihtml5.quirks.redraw(element)},0),event.preventDefault())});var titlePrefixes={IMG:"Image: ",A:"Link: "};dom.observe(element,"mouseover",function(event){var title,target=event.target,nodeName=target.nodeName;if("A"===nodeName||"IMG"===nodeName){var hasTitle=target.hasAttribute("title");hasTitle||(title=titlePrefixes[nodeName]+(target.getAttribute("href")||target.getAttribute("src")),target.setAttribute("title",title))}})}}(wysihtml5),function(wysihtml5){var INTERVAL=400;wysihtml5.views.Synchronizer=Base.extend({constructor:function(editor,textarea,composer){this.editor=editor,this.textarea=textarea,this.composer=composer,this._observe()},fromComposerToTextarea:function(shouldParseHtml){this.textarea.setValue(wysihtml5.lang.string(this.composer.getValue()).trim(),shouldParseHtml)},fromTextareaToComposer:function(shouldParseHtml){var textareaValue=this.textarea.getValue();textareaValue?this.composer.setValue(textareaValue,shouldParseHtml):(this.composer.clear(),this.editor.fire("set_placeholder"))},sync:function(shouldParseHtml){"textarea"===this.editor.currentView.name?this.fromTextareaToComposer(shouldParseHtml):this.fromComposerToTextarea(shouldParseHtml)},_observe:function(){var interval,that=this,form=this.textarea.element.form,startInterval=function(){interval=setInterval(function(){that.fromComposerToTextarea()},INTERVAL)},stopInterval=function(){clearInterval(interval),interval=null};startInterval(),form&&(wysihtml5.dom.observe(form,"submit",function(){that.sync(!0)}),wysihtml5.dom.observe(form,"reset",function(){setTimeout(function(){that.fromTextareaToComposer()},0)})),this.editor.observe("change_view",function(view){"composer"!==view||interval?"textarea"===view&&(that.fromComposerToTextarea(!0),stopInterval()):(that.fromTextareaToComposer(!0),startInterval())}),this.editor.observe("destroy:composer",stopInterval)}})}(wysihtml5),wysihtml5.views.Textarea=wysihtml5.views.View.extend({name:"textarea",constructor:function(parent,textareaElement,config){this.base(parent,textareaElement,config),this._observe()},clear:function(){this.element.value=""},getValue:function(parse){var value=this.isEmpty()?"":this.element.value;return parse&&(value=this.parent.parse(value)),value},setValue:function(html,parse){parse&&(html=this.parent.parse(html)),this.element.value=html},hasPlaceholderSet:function(){var supportsPlaceholder=wysihtml5.browser.supportsPlaceholderAttributeOn(this.element),placeholderText=this.element.getAttribute("placeholder")||null,value=this.element.value,isEmpty=!value;return supportsPlaceholder&&isEmpty||value===placeholderText},isEmpty:function(){return!wysihtml5.lang.string(this.element.value).trim()||this.hasPlaceholderSet()},_observe:function(){var element=this.element,parent=this.parent,eventMapping={focusin:"focus",focusout:"blur"},events=wysihtml5.browser.supportsEvent("focusin")?["focusin","focusout","change"]:["focus","blur","change"];parent.observe("beforeload",function(){wysihtml5.dom.observe(element,events,function(event){var eventName=eventMapping[event.type]||event.type;parent.fire(eventName).fire(eventName+":textarea")}),wysihtml5.dom.observe(element,["paste","drop"],function(){setTimeout(function(){parent.fire("paste").fire("paste:textarea")},0)})})}}),function(wysihtml5){var dom=wysihtml5.dom,CLASS_NAME_OPENED="wysihtml5-command-dialog-opened",SELECTOR_FORM_ELEMENTS="input, select, textarea",SELECTOR_FIELDS="[data-wysihtml5-dialog-field]",ATTRIBUTE_FIELDS="data-wysihtml5-dialog-field";wysihtml5.toolbar.Dialog=wysihtml5.lang.Dispatcher.extend({constructor:function(link,container){this.link=link,this.container=container},_observe:function(){if(!this._observed){var that=this,callbackWrapper=function(event){var attributes=that._serialize();attributes==that.elementToChange?that.fire("edit",attributes):that.fire("save",attributes),that.hide(),event.preventDefault(),event.stopPropagation()};dom.observe(that.link,"click",function(){dom.hasClass(that.link,CLASS_NAME_OPENED)&&setTimeout(function(){that.hide()},0)}),dom.observe(this.container,"keydown",function(event){var keyCode=event.keyCode;keyCode===wysihtml5.ENTER_KEY&&callbackWrapper(event),keyCode===wysihtml5.ESCAPE_KEY&&that.hide()}),dom.delegate(this.container,"[data-wysihtml5-dialog-action=save]","click",callbackWrapper),dom.delegate(this.container,"[data-wysihtml5-dialog-action=cancel]","click",function(event){that.fire("cancel"),that.hide(),event.preventDefault(),event.stopPropagation()});for(var formElements=this.container.querySelectorAll(SELECTOR_FORM_ELEMENTS),i=0,length=formElements.length,_clearInterval=function(){clearInterval(that.interval)};length>i;i++)dom.observe(formElements[i],"change",_clearInterval);this._observed=!0}},_serialize:function(){for(var data=this.elementToChange||{},fields=this.container.querySelectorAll(SELECTOR_FIELDS),length=fields.length,i=0;length>i;i++)data[fields[i].getAttribute(ATTRIBUTE_FIELDS)]=fields[i].value;return data},_interpolate:function(avoidHiddenFields){for(var field,fieldName,newValue,focusedElement=document.querySelector(":focus"),fields=this.container.querySelectorAll(SELECTOR_FIELDS),length=fields.length,i=0;length>i;i++)field=fields[i],field!==focusedElement&&(avoidHiddenFields&&"hidden"===field.type||(fieldName=field.getAttribute(ATTRIBUTE_FIELDS),newValue=this.elementToChange?this.elementToChange[fieldName]||"":field.defaultValue,field.value=newValue))},show:function(elementToChange){var that=this,firstField=this.container.querySelector(SELECTOR_FORM_ELEMENTS);if(this.elementToChange=elementToChange,this._observe(),this._interpolate(),elementToChange&&(this.interval=setInterval(function(){that._interpolate(!0)},500)),dom.addClass(this.link,CLASS_NAME_OPENED),this.container.style.display="",this.fire("show"),firstField&&!elementToChange)try{firstField.focus()}catch(e){}},hide:function(){clearInterval(this.interval),this.elementToChange=null,dom.removeClass(this.link,CLASS_NAME_OPENED),this.container.style.display="none",this.fire("hide")}})}(wysihtml5),function(wysihtml5){var dom=wysihtml5.dom,linkStyles={position:"relative"},wrapperStyles={left:0,margin:0,opacity:0,overflow:"hidden",padding:0,position:"absolute",top:0,zIndex:1},inputStyles={cursor:"inherit",fontSize:"50px",height:"50px",marginTop:"-25px",outline:0,padding:0,position:"absolute",right:"-4px",top:"50%"},inputAttributes={"x-webkit-speech":"",speech:""};wysihtml5.toolbar.Speech=function(parent,link){var input=document.createElement("input");if(!wysihtml5.browser.supportsSpeechApiOn(input))return link.style.display="none",void 0;var wrapper=document.createElement("div");wysihtml5.lang.object(wrapperStyles).merge({width:link.offsetWidth+"px",height:link.offsetHeight+"px"}),dom.insert(input).into(wrapper),dom.insert(wrapper).into(link),dom.setStyles(inputStyles).on(input),dom.setAttributes(inputAttributes).on(input),dom.setStyles(wrapperStyles).on(wrapper),dom.setStyles(linkStyles).on(link);var eventName="onwebkitspeechchange"in input?"webkitspeechchange":"speechchange";dom.observe(input,eventName,function(){parent.execCommand("insertText",input.value),input.value=""}),dom.observe(input,"click",function(event){dom.hasClass(link,"wysihtml5-command-disabled")&&event.preventDefault(),event.stopPropagation()})}}(wysihtml5),function(wysihtml5){var CLASS_NAME_COMMAND_DISABLED="wysihtml5-command-disabled",CLASS_NAME_COMMANDS_DISABLED="wysihtml5-commands-disabled",CLASS_NAME_COMMAND_ACTIVE="wysihtml5-command-active",CLASS_NAME_ACTION_ACTIVE="wysihtml5-action-active",dom=wysihtml5.dom;wysihtml5.toolbar.Toolbar=Base.extend({constructor:function(editor,container){this.editor=editor,this.container="string"==typeof container?document.getElementById(container):container,this.composer=editor.composer,this._getLinks("command"),this._getLinks("action"),this._observe(),this.show();for(var speechInputLinks=this.container.querySelectorAll("[data-wysihtml5-command=insertSpeech]"),length=speechInputLinks.length,i=0;length>i;i++)new wysihtml5.toolbar.Speech(this,speechInputLinks[i])},_getLinks:function(type){for(var link,group,name,value,dialog,links=this[type+"Links"]=wysihtml5.lang.array(this.container.querySelectorAll("[data-wysihtml5-"+type+"]")).get(),length=links.length,i=0,mapping=this[type+"Mapping"]={};length>i;i++)link=links[i],name=link.getAttribute("data-wysihtml5-"+type),value=link.getAttribute("data-wysihtml5-"+type+"-value"),group=this.container.querySelector("[data-wysihtml5-"+type+"-group='"+name+"']"),dialog=this._getDialog(link,name),mapping[name+":"+value]={link:link,group:group,name:name,value:value,dialog:dialog,state:!1}},_getDialog:function(link,command){var dialog,caretBookmark,that=this,dialogElement=this.container.querySelector("[data-wysihtml5-dialog='"+command+"']");return dialogElement&&(dialog=new wysihtml5.toolbar.Dialog(link,dialogElement),dialog.observe("show",function(){caretBookmark=that.composer.selection.getBookmark(),that.editor.fire("show:dialog",{command:command,dialogContainer:dialogElement,commandLink:link})
}),dialog.observe("save",function(attributes){caretBookmark&&that.composer.selection.setBookmark(caretBookmark),that._execCommand(command,attributes),that.editor.fire("save:dialog",{command:command,dialogContainer:dialogElement,commandLink:link})}),dialog.observe("cancel",function(){that.editor.focus(!1),that.editor.fire("cancel:dialog",{command:command,dialogContainer:dialogElement,commandLink:link})})),dialog},execCommand:function(command,commandValue){if(!this.commandsDisabled){var commandObj=this.commandMapping[command+":"+commandValue];commandObj&&commandObj.dialog&&!commandObj.state?commandObj.dialog.show():this._execCommand(command,commandValue)}},_execCommand:function(command,commandValue){this.editor.focus(!1),this.composer.commands.exec(command,commandValue),this._updateLinkStates()},execAction:function(action){var editor=this.editor;switch(action){case"change_view":editor.currentView===editor.textarea?editor.fire("change_view","composer"):editor.fire("change_view","textarea")}},_observe:function(){for(var that=this,editor=this.editor,container=this.container,links=this.commandLinks.concat(this.actionLinks),length=links.length,i=0;length>i;i++)dom.setAttributes({href:"javascript:;",unselectable:"on"}).on(links[i]);dom.delegate(container,"[data-wysihtml5-command]","mousedown",function(event){event.preventDefault()}),dom.delegate(container,"[data-wysihtml5-command]","click",function(event){var link=this,command=link.getAttribute("data-wysihtml5-command"),commandValue=link.getAttribute("data-wysihtml5-command-value");that.execCommand(command,commandValue),event.preventDefault()}),dom.delegate(container,"[data-wysihtml5-action]","click",function(event){var action=this.getAttribute("data-wysihtml5-action");that.execAction(action),event.preventDefault()}),editor.observe("focus:composer",function(){that.bookmark=null,clearInterval(that.interval),that.interval=setInterval(function(){that._updateLinkStates()},500)}),editor.observe("blur:composer",function(){clearInterval(that.interval)}),editor.observe("destroy:composer",function(){clearInterval(that.interval)}),editor.observe("change_view",function(currentView){setTimeout(function(){that.commandsDisabled="composer"!==currentView,that._updateLinkStates(),that.commandsDisabled?dom.addClass(container,CLASS_NAME_COMMANDS_DISABLED):dom.removeClass(container,CLASS_NAME_COMMANDS_DISABLED)},0)})},_updateLinkStates:function(){var i,state,action,command,commandMapping=(this.composer.element,this.commandMapping),actionMapping=this.actionMapping;for(i in commandMapping)command=commandMapping[i],this.commandsDisabled?(state=!1,dom.removeClass(command.link,CLASS_NAME_COMMAND_ACTIVE),command.group&&dom.removeClass(command.group,CLASS_NAME_COMMAND_ACTIVE),command.dialog&&command.dialog.hide()):(state=this.composer.commands.state(command.name,command.value),wysihtml5.lang.object(state).isArray()&&(state=1===state.length?state[0]:!0),dom.removeClass(command.link,CLASS_NAME_COMMAND_DISABLED),command.group&&dom.removeClass(command.group,CLASS_NAME_COMMAND_DISABLED)),command.state!==state&&(command.state=state,state?(dom.addClass(command.link,CLASS_NAME_COMMAND_ACTIVE),command.group&&dom.addClass(command.group,CLASS_NAME_COMMAND_ACTIVE),command.dialog&&("object"==typeof state?command.dialog.show(state):command.dialog.hide())):(dom.removeClass(command.link,CLASS_NAME_COMMAND_ACTIVE),command.group&&dom.removeClass(command.group,CLASS_NAME_COMMAND_ACTIVE),command.dialog&&command.dialog.hide()));for(i in actionMapping)action=actionMapping[i],"change_view"===action.name&&(action.state=this.editor.currentView===this.editor.textarea,action.state?dom.addClass(action.link,CLASS_NAME_ACTION_ACTIVE):dom.removeClass(action.link,CLASS_NAME_ACTION_ACTIVE))},show:function(){this.container.style.display=""},hide:function(){this.container.style.display="none"}})}(wysihtml5),function(wysihtml5){var undef,defaultConfig={name:undef,style:!0,toolbar:undef,autoLink:!0,parserRules:{tags:{br:{},span:{},div:{},p:{}},classes:{}},parser:wysihtml5.dom.parse,composerClassName:"wysihtml5-editor",bodyClassName:"wysihtml5-supported",stylesheets:[],placeholderText:undef,allowObjectResizing:!0,supportTouchDevices:!0};wysihtml5.Editor=wysihtml5.lang.Dispatcher.extend({constructor:function(textareaElement,config){if(this.textareaElement="string"==typeof textareaElement?document.getElementById(textareaElement):textareaElement,this.config=wysihtml5.lang.object({}).merge(defaultConfig).merge(config).get(),this.textarea=new wysihtml5.views.Textarea(this,this.textareaElement,this.config),this.currentView=this.textarea,this._isCompatible=wysihtml5.browser.supported(),!this._isCompatible||!this.config.supportTouchDevices&&wysihtml5.browser.isTouchDevice()){var that=this;return setTimeout(function(){that.fire("beforeload").fire("load")},0),void 0}wysihtml5.dom.addClass(document.body,this.config.bodyClassName),this.composer=new wysihtml5.views.Composer(this,this.textareaElement,this.config),this.currentView=this.composer,"function"==typeof this.config.parser&&this._initParser(),this.observe("beforeload",function(){this.synchronizer=new wysihtml5.views.Synchronizer(this,this.textarea,this.composer),this.config.toolbar&&(this.toolbar=new wysihtml5.toolbar.Toolbar(this,this.config.toolbar))});try{console.log("Heya! This page is using wysihtml5 for rich text editing. Check out https://github.com/xing/wysihtml5")}catch(e){}},isCompatible:function(){return this._isCompatible},clear:function(){return this.currentView.clear(),this},getValue:function(parse){return this.currentView.getValue(parse)},setValue:function(html,parse){return html?(this.currentView.setValue(html,parse),this):this.clear()},focus:function(setToEnd){return this.currentView.focus(setToEnd),this},disable:function(){return this.currentView.disable(),this},enable:function(){return this.currentView.enable(),this},isEmpty:function(){return this.currentView.isEmpty()},hasPlaceholderSet:function(){return this.currentView.hasPlaceholderSet()},parse:function(htmlOrElement){var returnValue=this.config.parser(htmlOrElement,this.config.parserRules,this.composer.sandbox.getDocument(),!0);return"object"==typeof htmlOrElement&&wysihtml5.quirks.redraw(htmlOrElement),returnValue},_initParser:function(){this.observe("paste:composer",function(){var keepScrollPosition=!0,that=this;that.composer.selection.executeAndRestore(function(){wysihtml5.quirks.cleanPastedHTML(that.composer.element),that.parse(that.composer.element)},keepScrollPosition)}),this.observe("paste:textarea",function(){var newValue,value=this.textarea.getValue();newValue=this.parse(value),this.textarea.setValue(newValue)})}})}(wysihtml5),!function($,wysi){"use strict";var tpl={"font-styles":function(locale,options){var size=options&&options.size?" btn-"+options.size:"";return"<li class='dropdown'><a class='btn dropdown-toggle"+size+"' data-toggle='dropdown' href='#'>"+"<i class='icon-font'></i>&nbsp;<span class='current-font'>"+locale.font_styles.normal+"</span>&nbsp;<b class='caret'></b>"+"</a>"+"<ul class='dropdown-menu'>"+"<li><a data-wysihtml5-command='formatBlock' data-wysihtml5-command-value='div' tabindex='-1'>"+locale.font_styles.normal+"</a></li>"+"<li><a data-wysihtml5-command='formatBlock' data-wysihtml5-command-value='h1' tabindex='-1'>"+locale.font_styles.h1+"</a></li>"+"<li><a data-wysihtml5-command='formatBlock' data-wysihtml5-command-value='h2' tabindex='-1'>"+locale.font_styles.h2+"</a></li>"+"<li><a data-wysihtml5-command='formatBlock' data-wysihtml5-command-value='h3' tabindex='-1'>"+locale.font_styles.h3+"</a></li>"+"<li><a data-wysihtml5-command='formatBlock' data-wysihtml5-command-value='h4'>"+locale.font_styles.h4+"</a></li>"+"<li><a data-wysihtml5-command='formatBlock' data-wysihtml5-command-value='h5'>"+locale.font_styles.h5+"</a></li>"+"<li><a data-wysihtml5-command='formatBlock' data-wysihtml5-command-value='h6'>"+locale.font_styles.h6+"</a></li>"+"</ul>"+"</li>"},emphasis:function(locale,options){var size=options&&options.size?" btn-"+options.size:"";return"<li><div class='btn-group'><a class='btn"+size+"' data-wysihtml5-command='bold' title='CTRL+B' tabindex='-1'>"+locale.emphasis.bold+"</a>"+"<a class='btn"+size+"' data-wysihtml5-command='italic' title='CTRL+I' tabindex='-1'>"+locale.emphasis.italic+"</a>"+"<a class='btn"+size+"' data-wysihtml5-command='underline' title='CTRL+U' tabindex='-1'>"+locale.emphasis.underline+"</a>"+"</div>"+"</li>"},lists:function(locale,options){var size=options&&options.size?" btn-"+options.size:"";return"<li><div class='btn-group'><a class='btn"+size+"' data-wysihtml5-command='insertUnorderedList' title='"+locale.lists.unordered+"' tabindex='-1'><i class='icon-list'></i></a>"+"<a class='btn"+size+"' data-wysihtml5-command='insertOrderedList' title='"+locale.lists.ordered+"' tabindex='-1'><i class='icon-th-list'></i></a>"+"<a class='btn"+size+"' data-wysihtml5-command='Outdent' title='"+locale.lists.outdent+"' tabindex='-1'><i class='icon-indent-right'></i></a>"+"<a class='btn"+size+"' data-wysihtml5-command='Indent' title='"+locale.lists.indent+"' tabindex='-1'><i class='icon-indent-left'></i></a>"+"</div>"+"</li>"},link:function(locale,options){var size=options&&options.size?" btn-"+options.size:"";return"<li><div class='bootstrap-wysihtml5-insert-link-modal modal hide fade'><div class='modal-header'><a class='close' data-dismiss='modal'>&times;</a><h3>"+locale.link.insert+"</h3>"+"</div>"+"<div class='modal-body'>"+"<input value='http://' class='bootstrap-wysihtml5-insert-link-url input-xlarge'>"+"<label class='checkbox'> <input type='checkbox' class='bootstrap-wysihtml5-insert-link-target' checked>"+locale.link.target+"</label>"+"</div>"+"<div class='modal-footer'>"+"<a href='#' class='btn' data-dismiss='modal'>"+locale.link.cancel+"</a>"+"<a href='#' class='btn btn-primary' data-dismiss='modal'>"+locale.link.insert+"</a>"+"</div>"+"</div>"+"<a class='btn"+size+"' data-wysihtml5-command='createLink' title='"+locale.link.insert+"' tabindex='-1'><i class='icon-share'></i></a>"+"</li>"},image:function(locale,options){var size=options&&options.size?" btn-"+options.size:"";return"<li><div class='bootstrap-wysihtml5-insert-image-modal modal hide fade'><div class='modal-header'><a class='close' data-dismiss='modal'>&times;</a><h3>"+locale.image.insert+"</h3>"+"</div>"+"<div class='modal-body'>"+"<input value='http://' class='bootstrap-wysihtml5-insert-image-url input-xlarge'>"+"</div>"+"<div class='modal-footer'>"+"<a href='#' class='btn' data-dismiss='modal'>"+locale.image.cancel+"</a>"+"<a href='#' class='btn btn-primary' data-dismiss='modal'>"+locale.image.insert+"</a>"+"</div>"+"</div>"+"<a class='btn"+size+"' data-wysihtml5-command='insertImage' title='"+locale.image.insert+"' tabindex='-1'><i class='icon-picture'></i></a>"+"</li>"},html:function(locale,options){var size=options&&options.size?" btn-"+options.size:"";return"<li><div class='btn-group'><a class='btn"+size+"' data-wysihtml5-action='change_view' title='"+locale.html.edit+"' tabindex='-1'><i class='icon-pencil'></i></a>"+"</div>"+"</li>"},color:function(locale,options){var size=options&&options.size?" btn-"+options.size:"";return"<li class='dropdown'><a class='btn dropdown-toggle"+size+"' data-toggle='dropdown' href='#' tabindex='-1'>"+"<span class='current-color'>"+locale.colours.black+"</span>&nbsp;<b class='caret'></b>"+"</a>"+"<ul class='dropdown-menu'>"+"<li><div class='wysihtml5-colors' data-wysihtml5-command-value='black'></div><a class='wysihtml5-colors-title' data-wysihtml5-command='foreColor' data-wysihtml5-command-value='black'>"+locale.colours.black+"</a></li>"+"<li><div class='wysihtml5-colors' data-wysihtml5-command-value='silver'></div><a class='wysihtml5-colors-title' data-wysihtml5-command='foreColor' data-wysihtml5-command-value='silver'>"+locale.colours.silver+"</a></li>"+"<li><div class='wysihtml5-colors' data-wysihtml5-command-value='gray'></div><a class='wysihtml5-colors-title' data-wysihtml5-command='foreColor' data-wysihtml5-command-value='gray'>"+locale.colours.gray+"</a></li>"+"<li><div class='wysihtml5-colors' data-wysihtml5-command-value='maroon'></div><a class='wysihtml5-colors-title' data-wysihtml5-command='foreColor' data-wysihtml5-command-value='maroon'>"+locale.colours.maroon+"</a></li>"+"<li><div class='wysihtml5-colors' data-wysihtml5-command-value='red'></div><a class='wysihtml5-colors-title' data-wysihtml5-command='foreColor' data-wysihtml5-command-value='red'>"+locale.colours.red+"</a></li>"+"<li><div class='wysihtml5-colors' data-wysihtml5-command-value='purple'></div><a class='wysihtml5-colors-title' data-wysihtml5-command='foreColor' data-wysihtml5-command-value='purple'>"+locale.colours.purple+"</a></li>"+"<li><div class='wysihtml5-colors' data-wysihtml5-command-value='green'></div><a class='wysihtml5-colors-title' data-wysihtml5-command='foreColor' data-wysihtml5-command-value='green'>"+locale.colours.green+"</a></li>"+"<li><div class='wysihtml5-colors' data-wysihtml5-command-value='olive'></div><a class='wysihtml5-colors-title' data-wysihtml5-command='foreColor' data-wysihtml5-command-value='olive'>"+locale.colours.olive+"</a></li>"+"<li><div class='wysihtml5-colors' data-wysihtml5-command-value='navy'></div><a class='wysihtml5-colors-title' data-wysihtml5-command='foreColor' data-wysihtml5-command-value='navy'>"+locale.colours.navy+"</a></li>"+"<li><div class='wysihtml5-colors' data-wysihtml5-command-value='blue'></div><a class='wysihtml5-colors-title' data-wysihtml5-command='foreColor' data-wysihtml5-command-value='blue'>"+locale.colours.blue+"</a></li>"+"<li><div class='wysihtml5-colors' data-wysihtml5-command-value='orange'></div><a class='wysihtml5-colors-title' data-wysihtml5-command='foreColor' data-wysihtml5-command-value='orange'>"+locale.colours.orange+"</a></li>"+"</ul>"+"</li>"}},templates=function(key,locale,options){return tpl[key](locale,options)},Wysihtml5=function(el,options){this.el=el;var toolbarOpts=options||defaultOptions;for(var t in toolbarOpts.customTemplates)tpl[t]=toolbarOpts.customTemplates[t];this.toolbar=this.createToolbar(el,toolbarOpts),this.editor=this.createEditor(options),window.editor=this.editor,$("iframe.wysihtml5-sandbox").each(function(i,el){$(el.contentWindow).off("focus.wysihtml5").on({"focus.wysihtml5":function(){$("li.dropdown").removeClass("open")}})})};Wysihtml5.prototype={constructor:Wysihtml5,createEditor:function(options){options=options||{},options=$.extend(!0,{},options),options.toolbar=this.toolbar[0];var editor=new wysi.Editor(this.el[0],options);if(options&&options.events)for(var eventName in options.events)editor.on(eventName,options.events[eventName]);return editor},createToolbar:function(el,options){var self=this,toolbar=$("<ul/>",{"class":"wysihtml5-toolbar",style:"display:none"}),culture=options.locale||defaultOptions.locale||"en";for(var key in defaultOptions){var value=!1;void 0!==options[key]?options[key]===!0&&(value=!0):value=defaultOptions[key],value===!0&&(toolbar.append(templates(key,locale[culture],options)),"html"===key&&this.initHtml(toolbar),"link"===key&&this.initInsertLink(toolbar),"image"===key&&this.initInsertImage(toolbar))}if(options.toolbar)for(key in options.toolbar)toolbar.append(options.toolbar[key]);return toolbar.find("a[data-wysihtml5-command='formatBlock']").click(function(e){var target=e.target||e.srcElement,el=$(target);self.toolbar.find(".current-font").text(el.html())}),toolbar.find("a[data-wysihtml5-command='foreColor']").click(function(e){var target=e.target||e.srcElement,el=$(target);self.toolbar.find(".current-color").text(el.html())}),this.el.before(toolbar),toolbar},initHtml:function(toolbar){var changeViewSelector="a[data-wysihtml5-action='change_view']";toolbar.find(changeViewSelector).click(function(){toolbar.find("a.btn").not(changeViewSelector).toggleClass("disabled")})},initInsertImage:function(toolbar){var caretBookmark,self=this,insertImageModal=toolbar.find(".bootstrap-wysihtml5-insert-image-modal"),urlInput=insertImageModal.find(".bootstrap-wysihtml5-insert-image-url"),insertButton=insertImageModal.find("a.btn-primary"),initialValue=urlInput.val(),insertImage=function(){var url=urlInput.val();urlInput.val(initialValue),self.editor.currentView.element.focus(),caretBookmark&&(self.editor.composer.selection.setBookmark(caretBookmark),caretBookmark=null),self.editor.composer.commands.exec("insertImage",url)};urlInput.keypress(function(e){13==e.which&&(insertImage(),insertImageModal.modal("hide"))}),insertButton.click(insertImage),insertImageModal.on("shown",function(){urlInput.focus()}),insertImageModal.on("hide",function(){self.editor.currentView.element.focus()}),toolbar.find("a[data-wysihtml5-command=insertImage]").click(function(){var activeButton=$(this).hasClass("wysihtml5-command-active");return activeButton?!0:(self.editor.currentView.element.focus(!1),caretBookmark=self.editor.composer.selection.getBookmark(),insertImageModal.appendTo("body").modal("show"),insertImageModal.on("click.dismiss.modal",'[data-dismiss="modal"]',function(e){e.stopPropagation()}),!1)})},initInsertLink:function(toolbar){var caretBookmark,self=this,insertLinkModal=toolbar.find(".bootstrap-wysihtml5-insert-link-modal"),urlInput=insertLinkModal.find(".bootstrap-wysihtml5-insert-link-url"),targetInput=insertLinkModal.find(".bootstrap-wysihtml5-insert-link-target"),insertButton=insertLinkModal.find("a.btn-primary"),initialValue=urlInput.val(),insertLink=function(){var url=urlInput.val();urlInput.val(initialValue),self.editor.currentView.element.focus(),caretBookmark&&(self.editor.composer.selection.setBookmark(caretBookmark),caretBookmark=null);var newWindow=targetInput.prop("checked");self.editor.composer.commands.exec("createLink",{href:url,target:newWindow?"_blank":"_self",rel:newWindow?"nofollow":""})};urlInput.keypress(function(e){13==e.which&&(insertLink(),insertLinkModal.modal("hide"))}),insertButton.click(insertLink),insertLinkModal.on("shown",function(){urlInput.focus()}),insertLinkModal.on("hide",function(){self.editor.currentView.element.focus()}),toolbar.find("a[data-wysihtml5-command=createLink]").click(function(){var activeButton=$(this).hasClass("wysihtml5-command-active");return activeButton?!0:(self.editor.currentView.element.focus(!1),caretBookmark=self.editor.composer.selection.getBookmark(),insertLinkModal.appendTo("body").modal("show"),insertLinkModal.on("click.dismiss.modal",'[data-dismiss="modal"]',function(e){e.stopPropagation()}),!1)})}};var methods={resetDefaults:function(){$.fn.wysihtml5.defaultOptions=$.extend(!0,{},$.fn.wysihtml5.defaultOptionsCache)},bypassDefaults:function(options){return this.each(function(){var $this=$(this);$this.data("wysihtml5",new Wysihtml5($this,options))})},shallowExtend:function(options){var settings=$.extend({},$.fn.wysihtml5.defaultOptions,options||{},$(this).data()),that=this;return methods.bypassDefaults.apply(that,[settings])},deepExtend:function(options){var settings=$.extend(!0,{},$.fn.wysihtml5.defaultOptions,options||{}),that=this;return methods.bypassDefaults.apply(that,[settings])},init:function(options){var that=this;return methods.shallowExtend.apply(that,[options])}};$.fn.wysihtml5=function(method){return methods[method]?methods[method].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof method&&method?($.error("Method "+method+" does not exist on jQuery.wysihtml5"),void 0):methods.init.apply(this,arguments)},$.fn.wysihtml5.Constructor=Wysihtml5;var defaultOptions=$.fn.wysihtml5.defaultOptions={"font-styles":!0,color:!1,emphasis:!0,lists:!0,html:!1,link:!0,image:!0,events:{},parserRules:{classes:{"wysiwyg-color-silver":1,"wysiwyg-color-gray":1,"wysiwyg-color-white":1,"wysiwyg-color-maroon":1,"wysiwyg-color-red":1,"wysiwyg-color-purple":1,"wysiwyg-color-fuchsia":1,"wysiwyg-color-green":1,"wysiwyg-color-lime":1,"wysiwyg-color-olive":1,"wysiwyg-color-yellow":1,"wysiwyg-color-navy":1,"wysiwyg-color-blue":1,"wysiwyg-color-teal":1,"wysiwyg-color-aqua":1,"wysiwyg-color-orange":1},tags:{b:{},i:{},br:{},ol:{},ul:{},li:{},h1:{},h2:{},h3:{},h4:{},h5:{},h6:{},blockquote:{},u:1,img:{check_attributes:{width:"numbers",alt:"alt",src:"url",height:"numbers"}},a:{check_attributes:{href:"url",target:"alt",rel:"alt"}},span:1,div:1,code:1,pre:1}},stylesheets:["/assets/bootstrap-wysihtml5/wysiwyg-color.css"],locale:"en"};"undefined"==typeof $.fn.wysihtml5.defaultOptionsCache&&($.fn.wysihtml5.defaultOptionsCache=$.extend(!0,{},$.fn.wysihtml5.defaultOptions));var locale=$.fn.wysihtml5.locale={en:{font_styles:{normal:"Normal text",h1:"Heading 1",h2:"Heading 2",h3:"Heading 3",h4:"Heading 4",h5:"Heading 5",h6:"Heading 6"},emphasis:{bold:"Bold",italic:"Italic",underline:"Underline"},lists:{unordered:"Unordered list",ordered:"Ordered list",outdent:"Outdent",indent:"Indent"},link:{insert:"Insert link",cancel:"Cancel",target:"Open link in new window"},image:{insert:"Insert image",cancel:"Cancel"},html:{edit:"Edit HTML"},colours:{black:"Black",silver:"Silver",gray:"Grey",maroon:"Maroon",red:"Red",purple:"Purple",green:"Green",olive:"Olive",navy:"Navy",blue:"Blue",orange:"Orange"}}}}(window.jQuery,window.wysihtml5);